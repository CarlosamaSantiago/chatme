{"version":3,"file":"chat.js","mappings":"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","sources":["webpack://cliente-web/./src/chat.js"],"sourcesContent":["class ChatApp {\r\n    constructor() {\r\n        this.username = '';\r\n        this.targetUser = '';\r\n        this.isGroupChat = false;\r\n        this.colors = [\r\n            '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7',\r\n            '#DDA0DD', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E9'\r\n        ];\r\n        this.API_URL = 'http://localhost:3000';\r\n        this.WS_URL = 'ws://localhost:3000';\r\n        this.ws = null;\r\n        this.isRecording = false;\r\n        this.mediaRecorder = null;\r\n        this.audioChunks = [];\r\n        this.isInCall = false;\r\n        this.localStream = null;\r\n        this.remoteStream = null;\r\n        this.reconnectAttempts = 0;\r\n        this.maxReconnectAttempts = 5;\r\n\r\n        this.init();\r\n    }\r\n\r\n    init() {\r\n        this.getUsername();\r\n        this.setupEventListeners();\r\n    }\r\n\r\n    getUsername() {\r\n        this.username = prompt('Ingresa tu nombre:') || 'Usuario' + Math.floor(Math.random() * 1000);\r\n        document.getElementById('usernameDisplay').textContent = this.username;\r\n        document.getElementById('userAvatar').textContent = this.username[0].toUpperCase();\r\n        document.getElementById('userAvatar').style.backgroundColor = this.getAvatarColor(this.username);\r\n        this.registerUser();\r\n        this.refreshLists();\r\n        this.connectWebSocket();\r\n    }\r\n\r\n    async registerUser() {\r\n        try {\r\n            const response = await fetch(`${this.API_URL}/register`, {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/json' },\r\n                body: JSON.stringify({ username: this.username })\r\n            });\r\n            const result = await response.json();\r\n            console.log('Usuario registrado:', result);\r\n        } catch (err) {\r\n            console.error('Error registrando usuario', err);\r\n        }\r\n    }\r\n\r\n    // ConexiÃ³n WebSocket para mensajes en tiempo real\r\n    connectWebSocket() {\r\n        try {\r\n            this.ws = new WebSocket(this.WS_URL);\r\n\r\n            this.ws.onopen = () => {\r\n                console.log('WebSocket conectado');\r\n                this.reconnectAttempts = 0;\r\n                \r\n                // Registrar usuario en el WebSocket\r\n                this.ws.send(JSON.stringify({\r\n                    type: 'register',\r\n                    username: this.username\r\n                }));\r\n                \r\n                this.updateConnectionStatus(true);\r\n            };\r\n\r\n            this.ws.onmessage = (event) => {\r\n                try {\r\n                    const data = JSON.parse(event.data);\r\n                    this.handleWebSocketMessage(data);\r\n                } catch (e) {\r\n                    console.error('Error parseando mensaje WebSocket:', e);\r\n                }\r\n            };\r\n\r\n            this.ws.onclose = () => {\r\n                console.log('WebSocket desconectado');\r\n                this.updateConnectionStatus(false);\r\n                this.attemptReconnect();\r\n            };\r\n\r\n            this.ws.onerror = (error) => {\r\n                console.error('Error WebSocket:', error);\r\n                this.updateConnectionStatus(false);\r\n            };\r\n\r\n        } catch (error) {\r\n            console.error('Error conectando WebSocket:', error);\r\n            this.attemptReconnect();\r\n        }\r\n    }\r\n\r\n    attemptReconnect() {\r\n        if (this.reconnectAttempts < this.maxReconnectAttempts) {\r\n            this.reconnectAttempts++;\r\n            console.log(`Intentando reconexiÃ³n ${this.reconnectAttempts}/${this.maxReconnectAttempts}...`);\r\n            setTimeout(() => this.connectWebSocket(), 2000 * this.reconnectAttempts);\r\n        } else {\r\n            console.log('MÃ¡ximo de intentos de reconexiÃ³n alcanzado');\r\n        }\r\n    }\r\n\r\n    handleWebSocketMessage(data) {\r\n        console.log('Mensaje WebSocket recibido:', data);\r\n\r\n        switch (data.type) {\r\n            case 'registered':\r\n                console.log('Registrado en WebSocket como:', data.username);\r\n                break;\r\n\r\n            case 'newMessage':\r\n                this.handleNewMessage(data.message);\r\n                break;\r\n\r\n            case 'groupCreated':\r\n                console.log('Nuevo grupo creado:', data.groupName);\r\n                this.loadGroups();\r\n                break;\r\n\r\n            case 'incomingCall':\r\n                this.handleIncomingCall(data);\r\n                break;\r\n\r\n            default:\r\n                console.log('Tipo de mensaje no reconocido:', data.type);\r\n        }\r\n    }\r\n\r\n    handleNewMessage(message) {\r\n        // Verificar si el mensaje es relevante para el chat actual\r\n        const isRelevant = this.isMessageRelevant(message);\r\n        \r\n        if (isRelevant) {\r\n            this.displayMessage(message);\r\n        }\r\n        \r\n        // Mostrar notificaciÃ³n si el mensaje no es del usuario actual\r\n        if (message.from !== this.username) {\r\n            this.showNotification(message);\r\n        }\r\n    }\r\n\r\n    isMessageRelevant(message) {\r\n        if (!this.targetUser) return false;\r\n        \r\n        if (message.isGroup) {\r\n            return message.to === this.targetUser;\r\n        } else {\r\n            return (message.from === this.targetUser && message.to === this.username) ||\r\n                   (message.from === this.username && message.to === this.targetUser);\r\n        }\r\n    }\r\n\r\n    showNotification(message) {\r\n        // NotificaciÃ³n en el tÃ­tulo de la pÃ¡gina\r\n        if (document.hidden) {\r\n            document.title = `ðŸ’¬ Nuevo mensaje de ${message.from}`;\r\n            setTimeout(() => {\r\n                document.title = 'Chat App';\r\n            }, 3000);\r\n        }\r\n    }\r\n\r\n    handleIncomingCall(data) {\r\n        if (data.to === this.username || data.isGroup) {\r\n            const accept = confirm(`ðŸ“ž Llamada entrante de ${data.from}. Â¿Aceptar?`);\r\n            if (accept) {\r\n                this.targetUser = data.from;\r\n                this.isGroupChat = data.isGroup;\r\n                this.updateChatInterface();\r\n                this.joinCall();\r\n            }\r\n        }\r\n    }\r\n\r\n    updateConnectionStatus(connected) {\r\n        const statusEl = document.getElementById('connectionStatus');\r\n        if (statusEl) {\r\n            statusEl.className = connected ? 'status-connected' : 'status-disconnected';\r\n            statusEl.textContent = connected ? 'â— Conectado' : 'â—‹ Desconectado';\r\n        }\r\n    }\r\n\r\n    async sendMessage() {\r\n        const messageInput = document.getElementById('messageInput');\r\n        const message = messageInput.value.trim();\r\n\r\n        if (message && this.targetUser) {\r\n            try {\r\n                await fetch(`${this.API_URL}/sendMessage`, {\r\n                    method: 'POST',\r\n                    headers: { 'Content-Type': 'application/json' },\r\n                    body: JSON.stringify({\r\n                        from: this.username,\r\n                        to: this.targetUser,\r\n                        message: message,\r\n                        isGroup: this.isGroupChat\r\n                    })\r\n                });\r\n\r\n                messageInput.value = '';\r\n                // El mensaje llegarÃ¡ via WebSocket\r\n            } catch (error) {\r\n                console.error('Error enviando mensaje:', error);\r\n                alert('Error al enviar mensaje: ' + error.message);\r\n            }\r\n        }\r\n    }\r\n\r\n    async sendVoiceNote() {\r\n        if (!this.targetUser) {\r\n            alert('Selecciona un destinatario primero');\r\n            return;\r\n        }\r\n\r\n        console.log('Iniciando grabaciÃ³n de voz...');\r\n\r\n        try {\r\n            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });\r\n            console.log('MicrÃ³fono accedido correctamente');\r\n            \r\n            // Detectar el mejor mimeType soportado\r\n            let mimeType = 'audio/webm';\r\n            if (!MediaRecorder.isTypeSupported(mimeType)) {\r\n                mimeType = 'audio/ogg';\r\n                if (!MediaRecorder.isTypeSupported(mimeType)) {\r\n                    mimeType = 'audio/mp4';\r\n                    if (!MediaRecorder.isTypeSupported(mimeType)) {\r\n                        mimeType = ''; // Usar el default del navegador\r\n                    }\r\n                }\r\n            }\r\n            console.log('Usando mimeType:', mimeType || 'default');\r\n            \r\n            const options = mimeType ? { mimeType } : {};\r\n            this.mediaRecorder = new MediaRecorder(stream, options);\r\n            this.audioChunks = [];\r\n            this.currentAudioStream = stream; // Guardar referencia al stream\r\n\r\n            this.mediaRecorder.ondataavailable = (event) => {\r\n                if (event.data.size > 0) {\r\n                    this.audioChunks.push(event.data);\r\n                }\r\n            };\r\n\r\n            this.mediaRecorder.onstop = async () => {\r\n                console.log('GrabaciÃ³n detenida, procesando audio...');\r\n                const audioBlob = new Blob(this.audioChunks, { type: mimeType || 'audio/webm' });\r\n                console.log('Audio blob creado, tamaÃ±o:', audioBlob.size);\r\n                \r\n                // Convertir a Base64\r\n                const reader = new FileReader();\r\n                reader.onloadend = async () => {\r\n                    const base64Audio = reader.result.split(',')[1];\r\n                    console.log('Audio convertido a Base64, longitud:', base64Audio?.length);\r\n                    \r\n                    try {\r\n                        const response = await fetch(`${this.API_URL}/sendVoiceNote`, {\r\n                            method: 'POST',\r\n                            headers: { 'Content-Type': 'application/json' },\r\n                            body: JSON.stringify({\r\n                                from: this.username,\r\n                                to: this.targetUser,\r\n                                audioData: base64Audio,\r\n                                isGroup: this.isGroupChat\r\n                            })\r\n                        });\r\n                        console.log('Nota de voz enviada, respuesta:', response.status);\r\n                    } catch (error) {\r\n                        console.error('Error enviando nota de voz:', error);\r\n                        alert('Error al enviar nota de voz');\r\n                    }\r\n                };\r\n                reader.readAsDataURL(audioBlob);\r\n\r\n                // Detener el stream\r\n                if (this.currentAudioStream) {\r\n                    this.currentAudioStream.getTracks().forEach(track => track.stop());\r\n                    this.currentAudioStream = null;\r\n                }\r\n            };\r\n\r\n            this.mediaRecorder.start();\r\n            this.isRecording = true;\r\n            this.updateRecordingUI(true);\r\n\r\n            // Detener despuÃ©s de 60 segundos mÃ¡ximo\r\n            setTimeout(() => {\r\n                if (this.isRecording) {\r\n                    this.stopRecording();\r\n                }\r\n            }, 60000);\r\n\r\n        } catch (error) {\r\n            console.error('Error accediendo al micrÃ³fono:', error);\r\n            alert('Error al acceder al micrÃ³fono. AsegÃºrate de dar permisos.');\r\n        }\r\n    }\r\n\r\n    stopRecording() {\r\n        if (this.mediaRecorder && this.isRecording) {\r\n            this.mediaRecorder.stop();\r\n            this.isRecording = false;\r\n            this.updateRecordingUI(false);\r\n        }\r\n    }\r\n\r\n    updateRecordingUI(recording) {\r\n        const btn = document.getElementById('voiceNoteBtn');\r\n        if (btn) {\r\n            if (recording) {\r\n                btn.classList.add('recording');\r\n                btn.innerHTML = 'â¹ Detener';\r\n            } else {\r\n                btn.classList.remove('recording');\r\n                btn.innerHTML = 'ðŸŽ¤ Voz';\r\n            }\r\n        }\r\n    }\r\n\r\n    async startCall() {\r\n        console.log('=== startCall ===');\r\n        console.log('targetUser:', this.targetUser);\r\n        console.log('isInCall:', this.isInCall);\r\n        \r\n        if (!this.targetUser) {\r\n            alert('âš ï¸ Primero selecciona un usuario o grupo para llamar');\r\n            return;\r\n        }\r\n\r\n        if (this.isInCall) {\r\n            console.log('Terminando llamada...');\r\n            this.endCall();\r\n            return;\r\n        }\r\n\r\n        try {\r\n            console.log('Enviando solicitud de llamada al servidor...');\r\n            \r\n            const response = await fetch(`${this.API_URL}/startCall`, {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/json' },\r\n                body: JSON.stringify({\r\n                    from: this.username,\r\n                    to: this.targetUser,\r\n                    isGroup: this.isGroupChat\r\n                })\r\n            });\r\n            \r\n            if (!response.ok) {\r\n                throw new Error('Error del servidor: ' + response.status);\r\n            }\r\n            \r\n            const result = await response.json();\r\n            console.log('Servidor respondiÃ³:', result);\r\n\r\n            // Iniciar la llamada localmente\r\n            await this.joinCall();\r\n\r\n        } catch (error) {\r\n            console.error('Error iniciando llamada:', error);\r\n            alert('âŒ Error al iniciar llamada: ' + error.message);\r\n        }\r\n    }\r\n\r\n    async joinCall() {\r\n        try {\r\n            console.log('Solicitando acceso al micrÃ³fono...');\r\n            \r\n            // Solo obtener acceso al micrÃ³fono (llamada de voz, NO video)\r\n            this.localStream = await navigator.mediaDevices.getUserMedia({ \r\n                audio: true,\r\n                video: false\r\n            });\r\n            console.log('âœ“ MicrÃ³fono activado para llamada de voz');\r\n\r\n            // Mostrar indicador de llamada en curso\r\n            const callIndicator = document.getElementById('callIndicator');\r\n            if (callIndicator) {\r\n                callIndicator.style.display = 'flex';\r\n                console.log('âœ“ Indicador de llamada mostrado');\r\n            } else {\r\n                console.warn('âš  No se encontrÃ³ el indicador de llamada');\r\n            }\r\n\r\n            this.isInCall = true;\r\n            this.updateCallUI(true);\r\n            this.startCallTimer();\r\n\r\n            // Mostrar mensaje de llamada en el chat\r\n            this.displayMessage({\r\n                from: this.username,\r\n                to: this.targetUser,\r\n                message: 'ðŸ“ž Llamada de voz iniciada',\r\n                type: 'call',\r\n                timestamp: new Date().toISOString()\r\n            });\r\n\r\n            console.log('âœ“ Llamada de voz iniciada correctamente');\r\n\r\n        } catch (error) {\r\n            console.error('Error accediendo al micrÃ³fono:', error);\r\n            \r\n            if (error.name === 'NotAllowedError') {\r\n                alert('âŒ Permiso de micrÃ³fono denegado. Permite el acceso al micrÃ³fono para hacer llamadas.');\r\n            } else if (error.name === 'NotFoundError') {\r\n                alert('âŒ No se encontrÃ³ micrÃ³fono. Conecta un micrÃ³fono para hacer llamadas.');\r\n            } else {\r\n                alert('âŒ Error al acceder al micrÃ³fono: ' + error.message);\r\n            }\r\n        }\r\n    }\r\n\r\n    startCallTimer() {\r\n        this.callStartTime = Date.now();\r\n        this.callTimerInterval = setInterval(() => {\r\n            const elapsed = Math.floor((Date.now() - this.callStartTime) / 1000);\r\n            const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');\r\n            const seconds = (elapsed % 60).toString().padStart(2, '0');\r\n            const timerEl = document.getElementById('callTimer');\r\n            if (timerEl) {\r\n                timerEl.textContent = `${minutes}:${seconds}`;\r\n            }\r\n        }, 1000);\r\n    }\r\n\r\n    endCall() {\r\n        console.log('=== Terminando llamada ===');\r\n        \r\n        // Detener stream de audio\r\n        if (this.localStream) {\r\n            this.localStream.getTracks().forEach(track => {\r\n                track.stop();\r\n                console.log('Track detenido:', track.kind);\r\n            });\r\n            this.localStream = null;\r\n        }\r\n\r\n        // Ocultar indicador de llamada\r\n        const callIndicator = document.getElementById('callIndicator');\r\n        if (callIndicator) {\r\n            callIndicator.style.display = 'none';\r\n        }\r\n\r\n        // Detener timer\r\n        if (this.callTimerInterval) {\r\n            clearInterval(this.callTimerInterval);\r\n            this.callTimerInterval = null;\r\n        }\r\n\r\n        // Calcular duraciÃ³n\r\n        const duration = this.callStartTime \r\n            ? Math.floor((Date.now() - this.callStartTime) / 1000) \r\n            : 0;\r\n        const minutes = Math.floor(duration / 60);\r\n        const seconds = duration % 60;\r\n        const durationStr = `${minutes}:${seconds.toString().padStart(2, '0')}`;\r\n\r\n        this.isInCall = false;\r\n        this.callStartTime = null;\r\n        this.updateCallUI(false);\r\n\r\n        // Mostrar mensaje de fin de llamada\r\n        this.displayMessage({\r\n            from: this.username,\r\n            to: this.targetUser,\r\n            message: `ðŸ“ž Llamada finalizada (${durationStr})`,\r\n            type: 'call',\r\n            timestamp: new Date().toISOString()\r\n        });\r\n\r\n        console.log('âœ“ Llamada terminada, duraciÃ³n:', durationStr);\r\n    }\r\n\r\n    updateCallUI(inCall) {\r\n        const btn = document.getElementById('callBtn');\r\n        if (btn) {\r\n            if (inCall) {\r\n                btn.classList.add('in-call');\r\n                btn.innerHTML = 'ðŸ“ž Colgar';\r\n            } else {\r\n                btn.classList.remove('in-call');\r\n                btn.innerHTML = 'ðŸ“ž Llamar';\r\n            }\r\n        }\r\n    }\r\n\r\n    async createGroup() {\r\n        const groupInput = document.getElementById('newGroupName');\r\n        const groupName = groupInput.value.trim();\r\n        \r\n        console.log('createGroup interno llamado, nombre:', groupName);\r\n\r\n        if (groupName) {\r\n            try {\r\n                const response = await fetch(`${this.API_URL}/createGroup`, {\r\n                    method: 'POST',\r\n                    headers: { 'Content-Type': 'application/json' },\r\n                    body: JSON.stringify({ groupName })\r\n                });\r\n                const result = await response.json();\r\n                console.log('Grupo creado, respuesta:', result);\r\n                alert(`Grupo creado: ${groupName}`);\r\n                groupInput.value = '';\r\n                this.loadGroups();\r\n            } catch (error) {\r\n                console.error('Error creando grupo:', error);\r\n                alert('Error al crear grupo: ' + error.message);\r\n            }\r\n        } else {\r\n            alert('Por favor ingresa un nombre para el grupo');\r\n        }\r\n    }\r\n\r\n    selectUser(user) {\r\n        if (user === this.username) return;\r\n        this.targetUser = user;\r\n        this.isGroupChat = false;\r\n        this.updateChatInterface();\r\n        this.loadHistory(user);\r\n    }\r\n\r\n    selectGroup(group) {\r\n        this.targetUser = group;\r\n        this.isGroupChat = true;\r\n        this.updateChatInterface();\r\n        this.loadHistory(group);\r\n    }\r\n\r\n    async loadHistory(target) {\r\n        try {\r\n            const response = await fetch(`${this.API_URL}/getHistory`, {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/json' },\r\n                body: JSON.stringify({\r\n                    target,\r\n                    from: this.username,\r\n                    isGroup: this.isGroupChat\r\n                })\r\n            });\r\n            \r\n            const result = await response.json();\r\n            \r\n            let messages = [];\r\n            if (result && result.messages) {\r\n                messages = result.messages;\r\n            } else if (Array.isArray(result)) {\r\n                messages = result;\r\n            }\r\n            \r\n            this.displayHistory(messages);\r\n        } catch (error) {\r\n            console.error('Error cargando historial:', error);\r\n        }\r\n    }\r\n\r\n    async refreshLists() {\r\n        await this.loadGroups();\r\n        await this.loadUsers();\r\n    }\r\n\r\n    async loadGroups() {\r\n        try {\r\n            const response = await fetch(`${this.API_URL}/getGroups`, {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/json' },\r\n                body: JSON.stringify({})\r\n            });\r\n            const result = await response.json();\r\n            let groups = [];\r\n            if (result && result.groups) {\r\n                groups = result.groups;\r\n            } else if (result && Array.isArray(result)) {\r\n                groups = result;\r\n            }\r\n            this.updateGroupList(groups);\r\n        } catch (error) {\r\n            console.error('Error cargando grupos:', error);\r\n        }\r\n    }\r\n\r\n    async loadUsers() {\r\n        try {\r\n            const response = await fetch(`${this.API_URL}/getUsers`, {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/json' },\r\n                body: JSON.stringify({})\r\n            });\r\n            const result = await response.json();\r\n            let users = [];\r\n            if (result && result.users) {\r\n                users = result.users;\r\n            } else if (result && Array.isArray(result)) {\r\n                users = result;\r\n            }\r\n            this.updateUserList(users);\r\n        } catch (error) {\r\n            console.error('Error cargando usuarios:', error);\r\n        }\r\n    }\r\n\r\n    updateUserList(users) {\r\n        const usersList = document.getElementById('usersList');\r\n        usersList.innerHTML = '';\r\n        users.forEach(user => {\r\n            if (user !== this.username) {\r\n                const el = document.createElement('div');\r\n                el.className = 'user-item';\r\n                if (user === this.targetUser && !this.isGroupChat) {\r\n                    el.classList.add('active');\r\n                }\r\n                el.innerHTML = `\r\n                    <div class=\"avatar\" style=\"background-color: ${this.getAvatarColor(user)}\">\r\n                        ${user[0].toUpperCase()}\r\n                    </div>\r\n                    <span>${user}</span>\r\n                `;\r\n                el.onclick = () => this.selectUser(user);\r\n                usersList.appendChild(el);\r\n            }\r\n        });\r\n    }\r\n\r\n    updateGroupList(groups) {\r\n        const groupsList = document.getElementById('groupsList');\r\n        groupsList.innerHTML = '';\r\n        if (!groups || groups.length === 0) {\r\n            groupsList.innerHTML = '<p style=\"color:#95a5a6;font-size:12px;padding:10px;\">No hay grupos</p>';\r\n            return;\r\n        }\r\n        groups.forEach(group => {\r\n            const el = document.createElement('div');\r\n            el.className = 'group-item';\r\n            if (group === this.targetUser && this.isGroupChat) {\r\n                el.classList.add('active');\r\n            }\r\n            el.innerHTML = `<div class=\"group-avatar\">#</div><span>${group}</span>`;\r\n            el.onclick = () => this.selectGroup(group);\r\n            groupsList.appendChild(el);\r\n        });\r\n    }\r\n\r\n    displayMessage(msg) {\r\n        const container = document.getElementById('messagesContainer');\r\n        if (!container) return;\r\n        \r\n        // Evitar duplicados\r\n        const existingMsgs = container.querySelectorAll('.message');\r\n        for (let i = existingMsgs.length - 1; i >= Math.max(0, existingMsgs.length - 5); i--) {\r\n            const existing = existingMsgs[i];\r\n            if (existing.dataset.from === msg.from && \r\n                existing.dataset.message === (msg.message || msg.content)) {\r\n                return; // Ya existe\r\n            }\r\n        }\r\n        \r\n        const messageEl = this.createMessageElement(msg);\r\n        container.appendChild(messageEl);\r\n        container.scrollTop = container.scrollHeight;\r\n    }\r\n\r\n    displayHistory(messages) {\r\n        const container = document.getElementById('messagesContainer');\r\n        if (!container) return;\r\n        \r\n        container.innerHTML = '';\r\n        if (Array.isArray(messages) && messages.length > 0) {\r\n            messages.forEach(m => {\r\n                try {\r\n                    let msgData = typeof m === 'string' ? JSON.parse(m) : m;\r\n                    if (msgData && msgData.from) {\r\n                        container.appendChild(this.createMessageElement(msgData));\r\n                    }\r\n                } catch (e) {\r\n                    console.error('Error parseando mensaje:', e, m);\r\n                }\r\n            });\r\n        }\r\n        container.scrollTop = container.scrollHeight;\r\n    }\r\n\r\n    createMessageElement(m) {\r\n        const own = m.from === this.username;\r\n        const div = document.createElement('div');\r\n        div.className = `message ${own ? 'right' : 'left'}`;\r\n        div.dataset.from = m.from;\r\n        div.dataset.message = m.message || m.content;\r\n        \r\n        let content = '';\r\n        if (m.type === 'audio' && m.audioData) {\r\n            // Determinar si audioData ya incluye el prefijo o es solo Base64\r\n            let audioSrc = m.audioData;\r\n            if (!audioSrc.startsWith('data:')) {\r\n                audioSrc = `data:audio/webm;base64,${audioSrc}`;\r\n            }\r\n            content = `\r\n                <div class=\"audio-message\">\r\n                    <span class=\"audio-icon\">ðŸŽµ</span>\r\n                    <audio controls>\r\n                        <source src=\"${audioSrc}\" type=\"audio/webm\">\r\n                        Tu navegador no soporta audio.\r\n                    </audio>\r\n                </div>\r\n            `;\r\n        } else if (m.type === 'call') {\r\n            content = `<div class=\"call-message\">ðŸ“ž ${this.escapeHtml(m.message || m.content)}</div>`;\r\n        } else {\r\n            content = `<div class=\"text\">${this.escapeHtml(m.message || m.content)}</div>`;\r\n        }\r\n        \r\n        const timestamp = m.timestamp ? new Date(m.timestamp).toLocaleTimeString() : new Date().toLocaleTimeString();\r\n        \r\n        div.innerHTML = `\r\n            <div class=\"avatar\" style=\"background-color:${this.getAvatarColor(m.from)}\">\r\n                ${m.from[0].toUpperCase()}\r\n            </div>\r\n            <div class=\"text-wrapper\">\r\n                ${!own ? `<div class=\"user-name\">${this.escapeHtml(m.from)}</div>` : ''}\r\n                ${content}\r\n                <div class=\"timestamp\">${timestamp}</div>\r\n            </div>`;\r\n        return div;\r\n    }\r\n\r\n    updateChatInterface() {\r\n        document.getElementById('chatTarget').textContent = this.targetUser;\r\n        document.getElementById('groupBadge').style.display = this.isGroupChat ? 'inline-block' : 'none';\r\n\r\n        const inputWrapper = document.getElementById('messageInputWrapper');\r\n        if (this.targetUser) {\r\n            inputWrapper.style.display = 'flex';\r\n        } else {\r\n            inputWrapper.style.display = 'none';\r\n        }\r\n        \r\n        // Actualizar listas para marcar el seleccionado\r\n        this.loadUsers();\r\n        this.loadGroups();\r\n    }\r\n\r\n    getAvatarColor(u) {\r\n        return this.colors[u.charCodeAt(0) % this.colors.length];\r\n    }\r\n\r\n    escapeHtml(t) {\r\n        if (!t) return '';\r\n        const div = document.createElement('div');\r\n        div.textContent = t;\r\n        return div.innerHTML;\r\n    }\r\n\r\n    setupEventListeners() {\r\n        document.getElementById('messageInput').addEventListener('keypress', e => {\r\n            if (e.key === 'Enter') this.sendMessage();\r\n        });\r\n        \r\n        // Actualizar lista de usuarios periÃ³dicamente (cada 10 segundos)\r\n        setInterval(() => {\r\n            this.loadUsers();\r\n        }, 10000);\r\n    }\r\n}\r\n\r\n// Inicializar la aplicaciÃ³n y exponer funciones globalmente\r\nlet chatApp;\r\n\r\nwindow.onload = () => { \r\n    chatApp = new ChatApp(); \r\n};\r\n\r\n// Exponer funciones al objeto window para que sean accesibles desde el HTML\r\nwindow.sendMessage = function() { \r\n    console.log('sendMessage llamado');\r\n    if (chatApp) chatApp.sendMessage(); \r\n    else console.error('chatApp no inicializado');\r\n};\r\n\r\nwindow.createGroup = function() { \r\n    console.log('createGroup llamado');\r\n    if (chatApp) chatApp.createGroup(); \r\n    else console.error('chatApp no inicializado');\r\n};\r\n\r\nwindow.sendVoiceNote = function() { \r\n    console.log('sendVoiceNote llamado, isRecording:', chatApp?.isRecording);\r\n    if (!chatApp) {\r\n        console.error('chatApp no inicializado');\r\n        return;\r\n    }\r\n    if (chatApp.isRecording) {\r\n        chatApp.stopRecording();\r\n    } else {\r\n        chatApp.sendVoiceNote();\r\n    }\r\n};\r\n\r\nwindow.startCall = function() { \r\n    console.log('startCall llamado');\r\n    if (chatApp) chatApp.startCall(); \r\n    else console.error('chatApp no inicializado');\r\n};\r\n"],"names":["ChatApp","constructor","this","username","targetUser","isGroupChat","colors","API_URL","WS_URL","ws","isRecording","mediaRecorder","audioChunks","isInCall","localStream","remoteStream","reconnectAttempts","maxReconnectAttempts","init","getUsername","setupEventListeners","prompt","Math","floor","random","document","getElementById","textContent","toUpperCase","style","backgroundColor","getAvatarColor","registerUser","refreshLists","connectWebSocket","response","fetch","method","headers","body","JSON","stringify","result","json","console","log","err","error","WebSocket","onopen","send","type","updateConnectionStatus","onmessage","event","data","parse","handleWebSocketMessage","e","onclose","attemptReconnect","onerror","setTimeout","handleNewMessage","message","groupName","loadGroups","handleIncomingCall","isMessageRelevant","displayMessage","from","showNotification","isGroup","to","hidden","title","confirm","updateChatInterface","joinCall","connected","statusEl","className","sendMessage","messageInput","value","trim","alert","sendVoiceNote","stream","navigator","mediaDevices","getUserMedia","audio","mimeType","MediaRecorder","isTypeSupported","options","currentAudioStream","ondataavailable","size","push","onstop","async","audioBlob","Blob","reader","FileReader","onloadend","base64Audio","split","length","audioData","status","readAsDataURL","getTracks","forEach","track","stop","start","updateRecordingUI","stopRecording","recording","btn","classList","add","innerHTML","remove","startCall","endCall","ok","Error","video","callIndicator","display","warn","updateCallUI","startCallTimer","timestamp","Date","toISOString","name","callStartTime","now","callTimerInterval","setInterval","elapsed","minutes","toString","padStart","seconds","timerEl","kind","clearInterval","duration","durationStr","inCall","createGroup","groupInput","selectUser","user","loadHistory","selectGroup","group","target","messages","Array","isArray","displayHistory","loadUsers","groups","updateGroupList","users","updateUserList","usersList","el","createElement","onclick","appendChild","groupsList","msg","container","existingMsgs","querySelectorAll","i","max","existing","dataset","content","messageEl","createMessageElement","scrollTop","scrollHeight","m","msgData","own","div","audioSrc","startsWith","escapeHtml","toLocaleTimeString","inputWrapper","u","charCodeAt","t","addEventListener","key","chatApp","window","onload"],"ignoreList":[],"sourceRoot":""}