(()=>{class e{constructor(){this.username="",this.targetUser="",this.isGroupChat=!1,this.colors=["#FF6B6B","#4ECDC4","#45B7D1","#96CEB4","#FFEAA7","#DDA0DD","#98D8C8","#F7DC6F","#BB8FCE","#85C1E9"],this.ICE_WS_URL="ws://localhost:10000",this.ws=null,this.isRecording=!1,this.mediaRecorder=null,this.audioChunks=[],this.isInCall=!1,this.localStream=null,this.remoteStream=null,this.pollingInterval=null,this.init()}init(){this.getUsername(),this.setupEventListeners(),this.startPollingFallback()}getUsername(){this.username=prompt("Ingresa tu nombre:")||"Usuario"+Math.floor(1e3*Math.random()),document.getElementById("usernameDisplay").textContent=this.username,document.getElementById("userAvatar").textContent=this.username[0].toUpperCase(),document.getElementById("userAvatar").style.backgroundColor=this.getAvatarColor(this.username),this.refreshLists(),this.registerUser()}async registerUser(){try{const e=await this.callIceRPC("registerUser",{username:this.username});console.log("Usuario registrado:",e)}catch(e){console.error("Error registrando usuario",e)}}async callIceRPC(e,t){const s={registerUser:"/register",createGroup:"/createGroup",sendMessage:"/sendMessage",sendAudio:"/sendMessage",startCall:"/sendMessage",getHistory:"/getHistory",getUsers:"/getUsers",getGroups:"/getGroups"}[e]||"/ice/"+e;try{let r=t;"sendMessage"===e?r={from:t.from,to:t.to,message:t.message||t.content,isGroup:t.isGroup}:"getHistory"===e&&(r={target:t.target,from:t.fromUser,isGroup:t.isGroup});const a=await fetch("http://localhost:3000"+s,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});if(!a.ok){const e=await a.json().catch(()=>({error:"Error desconocido"}));throw new Error(e.error||"Error en la llamada")}return await a.json()}catch(e){throw console.error("Error en llamada:",e),e}}async sendMessage(){const e=document.getElementById("messageInput"),t=e.value.trim();if(t&&this.targetUser)try{await this.callIceRPC("sendMessage",{from:this.username,to:this.targetUser,message:t,isGroup:this.isGroupChat}),e.value="",setTimeout(()=>{this.loadHistory(this.targetUser)},300)}catch(e){console.error("Error enviando mensaje:",e),alert("Error al enviar mensaje: "+e.message)}}async sendVoiceNote(){if(this.targetUser)try{const e=await navigator.mediaDevices.getUserMedia({audio:!0});this.mediaRecorder=new MediaRecorder(e),this.audioChunks=[],this.mediaRecorder.ondataavailable=e=>{e.data.size>0&&this.audioChunks.push(e.data)},this.mediaRecorder.onstop=async()=>{const t=new Blob(this.audioChunks,{type:"audio/webm"}),s=await t.arrayBuffer(),r=new Uint8Array(s);try{await this.callIceRPC("sendAudio",{from:this.username,to:this.targetUser,isGroup:this.isGroupChat,data:Array.from(r)}),this.displayMessage({from:this.username,to:this.targetUser,message:"[Nota de voz]",type:"audio",audioData:r,timestamp:(new Date).toISOString()}),e.getTracks().forEach(e=>e.stop())}catch(e){console.error("Error enviando nota de voz:",e),alert("Error al enviar nota de voz")}},this.mediaRecorder.start(),this.isRecording=!0,this.updateRecordingUI(!0),setTimeout(()=>{this.isRecording&&this.stopRecording()},1e4)}catch(e){console.error("Error accediendo al micrÃ³fono:",e),alert("Error al acceder al micrÃ³fono")}else alert("Selecciona un destinatario primero")}stopRecording(){this.mediaRecorder&&this.isRecording&&(this.mediaRecorder.stop(),this.isRecording=!1,this.updateRecordingUI(!1))}updateRecordingUI(e){const t=document.getElementById("voiceNoteBtn");t&&(e?(t.classList.add("recording"),t.textContent="â¹ Detener"):(t.classList.remove("recording"),t.textContent="ðŸŽ¤ Voz"))}async startCall(){if(this.targetUser)if(this.isInCall)this.endCall();else try{await this.callIceRPC("startCall",{from:this.username,to:this.targetUser,isGroup:this.isGroupChat}),this.localStream=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0});const e=document.getElementById("localVideo");e&&(e.srcObject=this.localStream,e.style.display="block"),this.isInCall=!0,this.updateCallUI(!0),this.displayMessage({from:this.username,to:this.targetUser,message:"[Llamada iniciada]",type:"call",timestamp:(new Date).toISOString()})}catch(e){console.error("Error iniciando llamada:",e),alert("Error al iniciar llamada")}else alert("Selecciona un destinatario primero")}endCall(){this.localStream&&(this.localStream.getTracks().forEach(e=>e.stop()),this.localStream=null);const e=document.getElementById("localVideo");e&&(e.srcObject=null,e.style.display="none"),this.isInCall=!1,this.updateCallUI(!1)}updateCallUI(e){const t=document.getElementById("callBtn");t&&(e?(t.classList.add("in-call"),t.textContent="ðŸ“ž Colgar"):(t.classList.remove("in-call"),t.textContent="ðŸ“ž Llamar"))}async createGroup(){const e=document.getElementById("newGroupName"),t=e.value.trim();if(t)try{await this.callIceRPC("createGroup",{groupName:t}),alert(`Grupo creado: ${t}`),e.value="",this.loadGroups()}catch(e){console.error("Error creando grupo:",e),alert("Error al crear grupo")}}selectUser(e){e!==this.username&&(this.targetUser=e,this.isGroupChat=!1,this.updateChatInterface(),this.loadHistory(e))}selectGroup(e){this.targetUser=e,this.isGroupChat=!0,this.updateChatInterface(),this.loadHistory(e)}async loadHistory(e){try{const t=await this.callIceRPC("getHistory",{target:e,fromUser:this.username,isGroup:this.isGroupChat});let s=[];t&&t.messages?s=t.messages:Array.isArray(t)&&(s=t),this.displayHistory(s)}catch(e){console.error("Error cargando historial:",e)}}startPollingFallback(){this.pollingInterval&&clearInterval(this.pollingInterval),this.pollingInterval=setInterval(()=>{this.targetUser&&this.loadHistory(this.targetUser),this.refreshLists()},2e3)}stopPolling(){this.pollingInterval&&(clearInterval(this.pollingInterval),this.pollingInterval=null)}async refreshLists(){await this.loadGroups(),await this.loadUsers()}async loadGroups(){try{const e=await this.callIceRPC("getGroups",{});let t=[];e&&e.groups?t=e.groups:e&&Array.isArray(e)?t=e:e&&"GROUP_LIST"===e.action&&e.groups&&(t=e.groups),this.updateGroupList(t)}catch(e){console.error("Error cargando grupos:",e)}}async loadUsers(){try{const e=await this.callIceRPC("getUsers",{});let t=[];e&&e.users?t=e.users:e&&Array.isArray(e)&&(t=e),this.updateUserList(t)}catch(e){console.error("Error cargando usuarios:",e)}}updateUserList(e){const t=document.getElementById("usersList");t.innerHTML="",e.forEach(e=>{if(e!==this.username){const s=document.createElement("div");s.className="user-item",s.innerHTML=`\n                    <div class="avatar" style="background-color: ${this.getAvatarColor(e)}">\n                        ${e[0].toUpperCase()}\n                    </div>\n                    <span>${e}</span>\n                `,s.onclick=()=>this.selectUser(e),t.appendChild(s)}})}updateGroupList(e){const t=document.getElementById("groupsList");t.innerHTML="",e&&0!==e.length?e.forEach(e=>{const s=document.createElement("div");s.className="group-item",s.innerHTML=`<div class="group-avatar">#</div><span>${e}</span>`,s.onclick=()=>this.selectGroup(e),t.appendChild(s)}):t.innerHTML='<p style="color:#95a5a6;font-size:12px;padding:10px;">No hay grupos</p>'}displayMessage(e){const t=document.getElementById("messagesContainer");t.appendChild(this.createMessageElement(e)),t.scrollTop=t.scrollHeight}displayHistory(e){const t=document.getElementById("messagesContainer");t&&(t.innerHTML="",Array.isArray(e)&&e.length>0&&e.forEach(e=>{try{let s="string"==typeof e?JSON.parse(e):e;s&&s.from&&t.appendChild(this.createMessageElement(s))}catch(t){console.error("Error parseando mensaje:",t,e)}}),t.scrollTop=t.scrollHeight)}createMessageElement(e){const t=e.from===this.username,s=document.createElement("div");s.className="message "+(t?"right":"left");let r="";return r="audio"===e.type?`\n                <div class="audio-message">\n                    <audio controls>\n                        <source src="data:audio/webm;base64,${this.arrayBufferToBase64(e.audioData)}" type="audio/webm">\n                    </audio>\n                </div>\n            `:"call"===e.type?`<div class="call-message">ðŸ“ž ${this.escapeHtml(e.message)}</div>`:`<div class="text">${this.escapeHtml(e.message||e.content)}</div>`,s.innerHTML=`\n            <div class="avatar" style="background-color:${this.getAvatarColor(e.from)}">\n                ${e.from[0].toUpperCase()}\n            </div>\n            <div class="text-wrapper">\n                ${t?"":`<div class="user-name">${this.escapeHtml(e.from)}</div>`}\n                ${r}\n                <div class="timestamp">${e.timestamp?new Date(e.timestamp).toLocaleTimeString():(new Date).toLocaleTimeString()}</div>\n            </div>`,s}arrayBufferToBase64(e){if(!e)return"";const t=new Uint8Array(e);let s="";for(let e=0;e<t.byteLength;e++)s+=String.fromCharCode(t[e]);return window.btoa(s)}updateChatInterface(){document.getElementById("chatTarget").textContent=this.targetUser,document.getElementById("groupBadge").style.display=this.isGroupChat?"inline-block":"none";const e=document.getElementById("messageInputWrapper");this.targetUser?e.style.display="flex":e.style.display="none"}getAvatarColor(e){return this.colors[e.charCodeAt(0)%this.colors.length]}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}setupEventListeners(){document.getElementById("messageInput").addEventListener("keypress",e=>{"Enter"===e.key&&this.sendMessage()})}}let t;window.onload=()=>{t=new e}})();
//# sourceMappingURL=chat.js.map