(()=>{class e{constructor(){this.username="",this.targetUser="",this.isGroupChat=!1,this.colors=["#FF6B6B","#4ECDC4","#45B7D1","#96CEB4","#FFEAA7","#DDA0DD","#98D8C8","#F7DC6F","#BB8FCE","#85C1E9"],this.API_URL="http://localhost:3000",this.WS_URL="ws://localhost:3000",this.ws=null,this.isRecording=!1,this.mediaRecorder=null,this.audioChunks=[],this.isInCall=!1,this.localStream=null,this.remoteStream=null,this.reconnectAttempts=0,this.maxReconnectAttempts=5,this.init()}init(){this.getUsername(),this.setupEventListeners()}getUsername(){this.username=prompt("Ingresa tu nombre:")||"Usuario"+Math.floor(1e3*Math.random()),document.getElementById("usernameDisplay").textContent=this.username,document.getElementById("userAvatar").textContent=this.username[0].toUpperCase(),document.getElementById("userAvatar").style.backgroundColor=this.getAvatarColor(this.username),this.registerUser(),this.refreshLists(),this.connectWebSocket()}async registerUser(){try{const e=await fetch(`${this.API_URL}/register`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:this.username})}),t=await e.json();console.log("Usuario registrado:",t)}catch(e){console.error("Error registrando usuario",e)}}connectWebSocket(){try{this.ws=new WebSocket(this.WS_URL),this.ws.onopen=()=>{console.log("WebSocket conectado"),this.reconnectAttempts=0,this.ws.send(JSON.stringify({type:"register",username:this.username})),this.updateConnectionStatus(!0)},this.ws.onmessage=e=>{try{const t=JSON.parse(e.data);this.handleWebSocketMessage(t)}catch(e){console.error("Error parseando mensaje WebSocket:",e)}},this.ws.onclose=()=>{console.log("WebSocket desconectado"),this.updateConnectionStatus(!1),this.attemptReconnect()},this.ws.onerror=e=>{console.error("Error WebSocket:",e),this.updateConnectionStatus(!1)}}catch(e){console.error("Error conectando WebSocket:",e),this.attemptReconnect()}}attemptReconnect(){this.reconnectAttempts<this.maxReconnectAttempts?(this.reconnectAttempts++,console.log(`Intentando reconexiÃ³n ${this.reconnectAttempts}/${this.maxReconnectAttempts}...`),setTimeout(()=>this.connectWebSocket(),2e3*this.reconnectAttempts)):console.log("MÃ¡ximo de intentos de reconexiÃ³n alcanzado")}handleWebSocketMessage(e){switch(console.log("Mensaje WebSocket recibido:",e),e.type){case"registered":console.log("Registrado en WebSocket como:",e.username);break;case"newMessage":this.handleNewMessage(e.message);break;case"groupCreated":console.log("Nuevo grupo creado:",e.groupName),this.loadGroups();break;case"incomingCall":this.handleIncomingCall(e);break;default:console.log("Tipo de mensaje no reconocido:",e.type)}}handleNewMessage(e){this.isMessageRelevant(e)&&this.displayMessage(e),e.from!==this.username&&this.showNotification(e)}isMessageRelevant(e){return!!this.targetUser&&(e.isGroup?e.to===this.targetUser:e.from===this.targetUser&&e.to===this.username||e.from===this.username&&e.to===this.targetUser)}showNotification(e){document.hidden&&(document.title=`ðŸ’¬ Nuevo mensaje de ${e.from}`,setTimeout(()=>{document.title="Chat App"},3e3))}handleIncomingCall(e){(e.to===this.username||e.isGroup)&&confirm(`ðŸ“ž Llamada entrante de ${e.from}. Â¿Aceptar?`)&&(this.targetUser=e.from,this.isGroupChat=e.isGroup,this.updateChatInterface(),this.joinCall())}updateConnectionStatus(e){const t=document.getElementById("connectionStatus");t&&(t.className=e?"status-connected":"status-disconnected",t.textContent=e?"â— Conectado":"â—‹ Desconectado")}async sendMessage(){const e=document.getElementById("messageInput"),t=e.value.trim();if(t&&this.targetUser)try{await fetch(`${this.API_URL}/sendMessage`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({from:this.username,to:this.targetUser,message:t,isGroup:this.isGroupChat})}),e.value=""}catch(e){console.error("Error enviando mensaje:",e),alert("Error al enviar mensaje: "+e.message)}}async sendVoiceNote(){if(this.targetUser){console.log("Iniciando grabaciÃ³n de voz...");try{const e=await navigator.mediaDevices.getUserMedia({audio:!0});console.log("MicrÃ³fono accedido correctamente");let t="audio/webm";MediaRecorder.isTypeSupported(t)||(t="audio/ogg",MediaRecorder.isTypeSupported(t)||(t="audio/mp4",MediaRecorder.isTypeSupported(t)||(t=""))),console.log("Usando mimeType:",t||"default");const s=t?{mimeType:t}:{};this.mediaRecorder=new MediaRecorder(e,s),this.audioChunks=[],this.currentAudioStream=e,this.mediaRecorder.ondataavailable=e=>{e.data.size>0&&this.audioChunks.push(e.data)},this.mediaRecorder.onstop=async()=>{console.log("GrabaciÃ³n detenida, procesando audio...");const e=new Blob(this.audioChunks,{type:t||"audio/webm"});console.log("Audio blob creado, tamaÃ±o:",e.size);const s=new FileReader;s.onloadend=async()=>{const e=s.result.split(",")[1];console.log("Audio convertido a Base64, longitud:",e?.length);try{const t=await fetch(`${this.API_URL}/sendVoiceNote`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({from:this.username,to:this.targetUser,audioData:e,isGroup:this.isGroupChat})});console.log("Nota de voz enviada, respuesta:",t.status)}catch(e){console.error("Error enviando nota de voz:",e),alert("Error al enviar nota de voz")}},s.readAsDataURL(e),this.currentAudioStream&&(this.currentAudioStream.getTracks().forEach(e=>e.stop()),this.currentAudioStream=null)},this.mediaRecorder.start(),this.isRecording=!0,this.updateRecordingUI(!0),setTimeout(()=>{this.isRecording&&this.stopRecording()},6e4)}catch(e){console.error("Error accediendo al micrÃ³fono:",e),alert("Error al acceder al micrÃ³fono. AsegÃºrate de dar permisos.")}}else alert("Selecciona un destinatario primero")}stopRecording(){this.mediaRecorder&&this.isRecording&&(this.mediaRecorder.stop(),this.isRecording=!1,this.updateRecordingUI(!1))}updateRecordingUI(e){const t=document.getElementById("voiceNoteBtn");t&&(e?(t.classList.add("recording"),t.innerHTML="â¹ Detener"):(t.classList.remove("recording"),t.innerHTML="ðŸŽ¤ Voz"))}async startCall(){if(console.log("=== startCall ==="),console.log("targetUser:",this.targetUser),console.log("isInCall:",this.isInCall),this.targetUser){if(this.isInCall)return console.log("Terminando llamada..."),void this.endCall();try{console.log("Enviando solicitud de llamada al servidor...");const e=await fetch(`${this.API_URL}/startCall`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({from:this.username,to:this.targetUser,isGroup:this.isGroupChat})});if(!e.ok)throw new Error("Error del servidor: "+e.status);const t=await e.json();console.log("Servidor respondiÃ³:",t),await this.joinCall()}catch(e){console.error("Error iniciando llamada:",e),alert("âŒ Error al iniciar llamada: "+e.message)}}else alert("âš ï¸ Primero selecciona un usuario o grupo para llamar")}async joinCall(){try{console.log("Solicitando acceso al micrÃ³fono..."),this.localStream=await navigator.mediaDevices.getUserMedia({audio:!0,video:!1}),console.log("âœ“ MicrÃ³fono activado para llamada de voz");const e=document.getElementById("callIndicator");e?(e.style.display="flex",console.log("âœ“ Indicador de llamada mostrado")):console.warn("âš  No se encontrÃ³ el indicador de llamada"),this.isInCall=!0,this.updateCallUI(!0),this.startCallTimer(),this.displayMessage({from:this.username,to:this.targetUser,message:"ðŸ“ž Llamada de voz iniciada",type:"call",timestamp:(new Date).toISOString()}),console.log("âœ“ Llamada de voz iniciada correctamente")}catch(e){console.error("Error accediendo al micrÃ³fono:",e),"NotAllowedError"===e.name?alert("âŒ Permiso de micrÃ³fono denegado. Permite el acceso al micrÃ³fono para hacer llamadas."):"NotFoundError"===e.name?alert("âŒ No se encontrÃ³ micrÃ³fono. Conecta un micrÃ³fono para hacer llamadas."):alert("âŒ Error al acceder al micrÃ³fono: "+e.message)}}startCallTimer(){this.callStartTime=Date.now(),this.callTimerInterval=setInterval(()=>{const e=Math.floor((Date.now()-this.callStartTime)/1e3),t=Math.floor(e/60).toString().padStart(2,"0"),s=(e%60).toString().padStart(2,"0"),o=document.getElementById("callTimer");o&&(o.textContent=`${t}:${s}`)},1e3)}endCall(){console.log("=== Terminando llamada ==="),this.localStream&&(this.localStream.getTracks().forEach(e=>{e.stop(),console.log("Track detenido:",e.kind)}),this.localStream=null);const e=document.getElementById("callIndicator");e&&(e.style.display="none"),this.callTimerInterval&&(clearInterval(this.callTimerInterval),this.callTimerInterval=null);const t=this.callStartTime?Math.floor((Date.now()-this.callStartTime)/1e3):0,s=`${Math.floor(t/60)}:${(t%60).toString().padStart(2,"0")}`;this.isInCall=!1,this.callStartTime=null,this.updateCallUI(!1),this.displayMessage({from:this.username,to:this.targetUser,message:`ðŸ“ž Llamada finalizada (${s})`,type:"call",timestamp:(new Date).toISOString()}),console.log("âœ“ Llamada terminada, duraciÃ³n:",s)}updateCallUI(e){const t=document.getElementById("callBtn");t&&(e?(t.classList.add("in-call"),t.innerHTML="ðŸ“ž Colgar"):(t.classList.remove("in-call"),t.innerHTML="ðŸ“ž Llamar"))}async createGroup(){const e=document.getElementById("newGroupName"),t=e.value.trim();if(console.log("createGroup interno llamado, nombre:",t),t)try{const s=await fetch(`${this.API_URL}/createGroup`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({groupName:t})}),o=await s.json();console.log("Grupo creado, respuesta:",o),alert(`Grupo creado: ${t}`),e.value="",this.loadGroups()}catch(e){console.error("Error creando grupo:",e),alert("Error al crear grupo: "+e.message)}else alert("Por favor ingresa un nombre para el grupo")}selectUser(e){e!==this.username&&(this.targetUser=e,this.isGroupChat=!1,this.updateChatInterface(),this.loadHistory(e))}selectGroup(e){this.targetUser=e,this.isGroupChat=!0,this.updateChatInterface(),this.loadHistory(e)}async loadHistory(e){try{const t=await fetch(`${this.API_URL}/getHistory`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({target:e,from:this.username,isGroup:this.isGroupChat})}),s=await t.json();let o=[];s&&s.messages?o=s.messages:Array.isArray(s)&&(o=s),this.displayHistory(o)}catch(e){console.error("Error cargando historial:",e)}}async refreshLists(){await this.loadGroups(),await this.loadUsers()}async loadGroups(){try{const e=await fetch(`${this.API_URL}/getGroups`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({})}),t=await e.json();let s=[];t&&t.groups?s=t.groups:t&&Array.isArray(t)&&(s=t),this.updateGroupList(s)}catch(e){console.error("Error cargando grupos:",e)}}async loadUsers(){try{const e=await fetch(`${this.API_URL}/getUsers`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({})}),t=await e.json();let s=[];t&&t.users?s=t.users:t&&Array.isArray(t)&&(s=t),this.updateUserList(s)}catch(e){console.error("Error cargando usuarios:",e)}}updateUserList(e){const t=document.getElementById("usersList");t.innerHTML="",e.forEach(e=>{if(e!==this.username){const s=document.createElement("div");s.className="user-item",e!==this.targetUser||this.isGroupChat||s.classList.add("active"),s.innerHTML=`\n                    <div class="avatar" style="background-color: ${this.getAvatarColor(e)}">\n                        ${e[0].toUpperCase()}\n                    </div>\n                    <span>${e}</span>\n                `,s.onclick=()=>this.selectUser(e),t.appendChild(s)}})}updateGroupList(e){const t=document.getElementById("groupsList");t.innerHTML="",e&&0!==e.length?e.forEach(e=>{const s=document.createElement("div");s.className="group-item",e===this.targetUser&&this.isGroupChat&&s.classList.add("active"),s.innerHTML=`<div class="group-avatar">#</div><span>${e}</span>`,s.onclick=()=>this.selectGroup(e),t.appendChild(s)}):t.innerHTML='<p style="color:#95a5a6;font-size:12px;padding:10px;">No hay grupos</p>'}displayMessage(e){const t=document.getElementById("messagesContainer");if(!t)return;const s=t.querySelectorAll(".message");for(let t=s.length-1;t>=Math.max(0,s.length-5);t--){const o=s[t];if(o.dataset.from===e.from&&o.dataset.message===(e.message||e.content))return}const o=this.createMessageElement(e);t.appendChild(o),t.scrollTop=t.scrollHeight}displayHistory(e){const t=document.getElementById("messagesContainer");t&&(t.innerHTML="",Array.isArray(e)&&e.length>0&&e.forEach(e=>{try{let s="string"==typeof e?JSON.parse(e):e;s&&s.from&&t.appendChild(this.createMessageElement(s))}catch(t){console.error("Error parseando mensaje:",t,e)}}),t.scrollTop=t.scrollHeight)}createMessageElement(e){const t=e.from===this.username,s=document.createElement("div");s.className="message "+(t?"right":"left"),s.dataset.from=e.from,s.dataset.message=e.message||e.content;let o="";if("audio"===e.type&&e.audioData){let t=e.audioData;t.startsWith("data:")||(t=`data:audio/webm;base64,${t}`),o=`\n                <div class="audio-message">\n                    <span class="audio-icon">ðŸŽµ</span>\n                    <audio controls>\n                        <source src="${t}" type="audio/webm">\n                        Tu navegador no soporta audio.\n                    </audio>\n                </div>\n            `}else o="call"===e.type?`<div class="call-message">ðŸ“ž ${this.escapeHtml(e.message||e.content)}</div>`:`<div class="text">${this.escapeHtml(e.message||e.content)}</div>`;const a=e.timestamp?new Date(e.timestamp).toLocaleTimeString():(new Date).toLocaleTimeString();return s.innerHTML=`\n            <div class="avatar" style="background-color:${this.getAvatarColor(e.from)}">\n                ${e.from[0].toUpperCase()}\n            </div>\n            <div class="text-wrapper">\n                ${t?"":`<div class="user-name">${this.escapeHtml(e.from)}</div>`}\n                ${o}\n                <div class="timestamp">${a}</div>\n            </div>`,s}updateChatInterface(){document.getElementById("chatTarget").textContent=this.targetUser,document.getElementById("groupBadge").style.display=this.isGroupChat?"inline-block":"none";const e=document.getElementById("messageInputWrapper");this.targetUser?e.style.display="flex":e.style.display="none",this.loadUsers(),this.loadGroups()}getAvatarColor(e){return this.colors[e.charCodeAt(0)%this.colors.length]}escapeHtml(e){if(!e)return"";const t=document.createElement("div");return t.textContent=e,t.innerHTML}setupEventListeners(){document.getElementById("messageInput").addEventListener("keypress",e=>{"Enter"===e.key&&this.sendMessage()}),setInterval(()=>{this.loadUsers()},1e4)}}let t;window.onload=()=>{t=new e},window.sendMessage=function(){console.log("sendMessage llamado"),t?t.sendMessage():console.error("chatApp no inicializado")},window.createGroup=function(){console.log("createGroup llamado"),t?t.createGroup():console.error("chatApp no inicializado")},window.sendVoiceNote=function(){console.log("sendVoiceNote llamado, isRecording:",t?.isRecording),t?t.isRecording?t.stopRecording():t.sendVoiceNote():console.error("chatApp no inicializado")},window.startCall=function(){console.log("startCall llamado"),t?t.startCall():console.error("chatApp no inicializado")}})();
//# sourceMappingURL=chat.js.map