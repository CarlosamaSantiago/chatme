/*! For license information please see chat.js.LICENSE.txt */
(()=>{"use strict";var e={33:(e,t)=>{function n(e){return n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},n(e)}function r(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return o(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?o(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,s=!0,c=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return s=e.done,e},e:function(e){c=!0,i=e},f:function(){try{s||null==n.return||n.return()}finally{if(c)throw i}}}}function o(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function a(){var e,t,n="function"==typeof Symbol?Symbol:{},r=n.iterator||"@@iterator",o=n.toStringTag||"@@toStringTag";function s(n,r,o,a){var s=r&&r.prototype instanceof l?r:l,u=Object.create(s.prototype);return i(u,"_invoke",function(n,r,o){var a,i,s,l=0,u=o||[],p=!1,d={p:0,n:0,v:e,a:f,f:f.bind(e,4),d:function(t,n){return a=t,i=0,s=e,d.n=n,c}};function f(n,r){for(i=n,s=r,t=0;!p&&l&&!o&&t<u.length;t++){var o,a=u[t],f=d.p,m=a[2];n>3?(o=m===r)&&(s=a[(i=a[4])?5:(i=3,3)],a[4]=a[5]=e):a[0]<=f&&((o=n<2&&f<a[1])?(i=0,d.v=r,d.n=a[1]):f<m&&(o=n<3||a[0]>r||r>m)&&(a[4]=n,a[5]=r,d.n=m,i=0))}if(o||n>1)return c;throw p=!0,r}return function(o,u,m){if(l>1)throw TypeError("Generator is already running");for(p&&1===u&&f(u,m),i=u,s=m;(t=i<2?e:s)||!p;){a||(i?i<3?(i>1&&(d.n=-1),f(i,s)):d.n=s:d.v=s);try{if(l=2,a){if(i||(o="next"),t=a[o]){if(!(t=t.call(a,s)))throw TypeError("iterator result is not an object");if(!t.done)return t;s=t.value,i<2&&(i=0)}else 1===i&&(t=a.return)&&t.call(a),i<2&&(s=TypeError("The iterator does not provide a '"+o+"' method"),i=1);a=e}else if((t=(p=d.n<0)?s:n.call(r,d))!==c)break}catch(t){a=e,i=1,s=t}finally{l=1}}return{value:t,done:p}}}(n,o,a),!0),u}var c={};function l(){}function u(){}function p(){}t=Object.getPrototypeOf;var d=[][r]?t(t([][r]())):(i(t={},r,function(){return this}),t),f=p.prototype=l.prototype=Object.create(d);function m(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,p):(e.__proto__=p,i(e,o,"GeneratorFunction")),e.prototype=Object.create(f),e}return u.prototype=p,i(f,"constructor",p),i(p,"constructor",u),u.displayName="GeneratorFunction",i(p,o,"GeneratorFunction"),i(f),i(f,o,"Generator"),i(f,r,function(){return this}),i(f,"toString",function(){return"[object Generator]"}),(a=function(){return{w:s,m}})()}function i(e,t,n,r){var o=Object.defineProperty;try{o({},"",{})}catch(e){o=0}i=function(e,t,n,r){function a(t,n){i(e,t,function(e){return this._invoke(t,n,e)})}t?o?o(e,t,{value:n,enumerable:!r,configurable:!r,writable:!r}):e[t]=n:(a("next",0),a("throw",1),a("return",2))},i(e,t,n,r)}function s(e,t,n,r,o,a,i){try{var s=e[a](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,o)}function c(e){return function(){var t=this,n=arguments;return new Promise(function(r,o){var a=e.apply(t,n);function i(e){s(a,r,o,i,c,"next",e)}function c(e){s(a,r,o,i,c,"throw",e)}i(void 0)})}}function l(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,u(r.key),r)}}function u(e){var t=function(e){if("object"!=n(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var r=t.call(e,"string");if("object"!=n(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==n(t)?t:t+""}Object.defineProperty(t,"__esModule",{value:!0}),t.WebRTCHandler=void 0,t.WebRTCHandler=function(){return e=function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.app=t,this.isInCall=!1,this.localStream=null,this.remoteStream=null,this.peerConnection=null,this.currentCallId=null,this.pendingCandidates=[],this.callPeer=null,this.callTimerInterval=null,this.callStartTime=null,this.iceServers={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun2.l.google.com:19302"}]}},t=[{key:"startCall",value:(s=c(a().m(function e(){var t,n,r=this;return a().w(function(e){for(;;)switch(e.p=e.n){case 0:if(console.log("=== startCall (WebRTC) ==="),console.log("targetUser:",this.app.targetUser),console.log("isInCall:",this.isInCall),this.app.targetUser){e.n=1;break}return alert("‚ö†Ô∏è Primero selecciona un usuario o grupo para llamar"),e.a(2);case 1:if(!this.isInCall){e.n=2;break}return console.log("Terminando llamada..."),this.endCall(),e.a(2);case 2:return e.p=2,this.callPeer=this.app.targetUser,console.log("Solicitando acceso al micr√≥fono..."),e.n=3,navigator.mediaDevices.getUserMedia({audio:!0,video:!1});case 3:return this.localStream=e.v,console.log("‚úì Micr√≥fono activado"),this.createPeerConnection(),this.localStream.getTracks().forEach(function(e){r.peerConnection.addTrack(e,r.localStream)}),e.n=4,this.peerConnection.createOffer();case 4:return t=e.v,e.n=5,this.peerConnection.setLocalDescription(t);case 5:console.log("‚úì Oferta SDP creada"),this.app.ws.send(JSON.stringify({type:"call-offer",to:this.app.targetUser,offer:t,isGroup:this.app.isGroupChat})),console.log("üìû Llamando a",this.app.targetUser),this.isInCall=!0,this.updateCallUI(!0),this.startCallTimer(),this.showCallIndicator(),this.app.ui.displayMessage({from:this.app.username,to:this.app.targetUser,message:"üìû Llamando...",type:"call",timestamp:(new Date).toISOString()}),e.n=7;break;case 6:e.p=6,n=e.v,console.error("Error iniciando llamada:",n),"NotAllowedError"===n.name?alert("‚ùå Permiso de micr√≥fono denegado."):"NotFoundError"===n.name?alert("‚ùå No se encontr√≥ micr√≥fono."):alert("‚ùå Error al iniciar llamada: "+n.message),this.cleanupCall();case 7:return e.a(2)}},e,this,[[2,6]])})),function(){return s.apply(this,arguments)})},{key:"handleCallOffer",value:(i=c(a().m(function e(t){var n,o,i,s,c,l,u,p,d,f,m=this;return a().w(function(e){for(;;)switch(e.p=e.n){case 0:if(n=t.from,o=t.offer,i=t.callId,s=t.isGroup,console.log("üìû Oferta de llamada recibida de ".concat(n)),!this.isInCall){e.n=1;break}return this.app.ws.send(JSON.stringify({type:"call-reject",to:n,callId:i})),e.a(2);case 1:if(confirm("üìû Llamada entrante de ".concat(n,". ¬øAceptar?"))){e.n=2;break}return this.app.ws.send(JSON.stringify({type:"call-reject",to:n,callId:i})),e.a(2);case 2:return e.p=2,this.callPeer=n,this.currentCallId=i,this.app.targetUser=n,this.app.isGroupChat=s||!1,this.app.ui.updateChatInterface(),e.n=3,navigator.mediaDevices.getUserMedia({audio:!0,video:!1});case 3:return this.localStream=e.v,console.log("‚úì Micr√≥fono activado"),this.createPeerConnection(),this.localStream.getTracks().forEach(function(e){m.peerConnection.addTrack(e,m.localStream)}),e.n=4,this.peerConnection.setRemoteDescription(new RTCSessionDescription(o));case 4:console.log("‚úì Oferta remota establecida"),c=r(this.pendingCandidates),e.p=5,c.s();case 6:if((l=c.n()).done){e.n=8;break}return u=l.value,e.n=7,this.peerConnection.addIceCandidate(new RTCIceCandidate(u));case 7:e.n=6;break;case 8:e.n=10;break;case 9:e.p=9,d=e.v,c.e(d);case 10:return e.p=10,c.f(),e.f(10);case 11:return this.pendingCandidates=[],e.n=12,this.peerConnection.createAnswer();case 12:return p=e.v,e.n=13,this.peerConnection.setLocalDescription(p);case 13:console.log("‚úì Respuesta SDP creada"),this.app.ws.send(JSON.stringify({type:"call-answer",to:n,answer:p,callId:i})),this.isInCall=!0,this.updateCallUI(!0),this.startCallTimer(),this.showCallIndicator(),this.app.ui.displayMessage({from:n,to:this.app.username,message:"üìû Llamada conectada",type:"call",timestamp:(new Date).toISOString()}),e.n=15;break;case 14:e.p=14,f=e.v,console.error("Error aceptando llamada:",f),alert("Error al aceptar llamada: "+f.message),this.cleanupCall();case 15:return e.a(2)}},e,this,[[5,9,10,11],[2,14]])})),function(e){return i.apply(this,arguments)})},{key:"handleCallAnswer",value:(o=c(a().m(function e(t){var n,r,o;return a().w(function(e){for(;;)switch(e.p=e.n){case 0:return n=t.from,r=t.answer,console.log("‚úÖ Respuesta de llamada recibida de ".concat(n)),e.p=1,e.n=2,this.peerConnection.setRemoteDescription(new RTCSessionDescription(r));case 2:console.log("‚úì Respuesta remota establecida - Llamada conectada!"),this.app.ui.displayMessage({from:this.app.username,to:n,message:"üìû Llamada conectada",type:"call",timestamp:(new Date).toISOString()}),e.n=4;break;case 3:e.p=3,o=e.v,console.error("Error procesando respuesta:",o);case 4:return e.a(2)}},e,this,[[1,3]])})),function(e){return o.apply(this,arguments)})},{key:"handleRemoteIceCandidate",value:(n=c(a().m(function e(t){var n,r;return a().w(function(e){for(;;)switch(e.p=e.n){case 0:if(t.from,n=t.candidate){e.n=1;break}return e.a(2);case 1:if(e.p=1,!this.peerConnection||!this.peerConnection.remoteDescription){e.n=3;break}return e.n=2,this.peerConnection.addIceCandidate(new RTCIceCandidate(n));case 2:console.log("‚úì Candidato ICE a√±adido"),e.n=4;break;case 3:this.pendingCandidates.push(n);case 4:e.n=6;break;case 5:e.p=5,r=e.v,console.error("Error a√±adiendo candidato ICE:",r);case 6:return e.a(2)}},e,this,[[1,5]])})),function(e){return n.apply(this,arguments)})},{key:"handleCallRejected",value:function(e){console.log("‚ùå Llamada rechazada por ".concat(e.from)),alert("".concat(e.from," rechaz√≥ la llamada")),this.cleanupCall()}},{key:"handleCallEnded",value:function(e){console.log("üì¥ Llamada terminada por ".concat(e.from));var t="user_disconnected"===e.reason?"El usuario se desconect√≥":"Llamada finalizada";this.app.ui.displayMessage({from:e.from,to:this.app.username,message:"üìû ".concat(t),type:"call",timestamp:(new Date).toISOString()}),this.cleanupCall()}},{key:"handleCallFailed",value:function(e){console.log("‚ùå Llamada fallida: ".concat(e.reason)),alert("No se pudo conectar la llamada: ".concat(e.to," no est√° disponible")),this.cleanupCall()}},{key:"createPeerConnection",value:function(){var e=this;console.log("Creando RTCPeerConnection..."),this.peerConnection=new RTCPeerConnection(this.iceServers),this.peerConnection.onicecandidate=function(t){t.candidate&&(console.log("Candidato ICE local generado"),e.app.ws.send(JSON.stringify({type:"ice-candidate",to:e.callPeer,candidate:t.candidate})))},this.peerConnection.onconnectionstatechange=function(){console.log("Estado de conexi√≥n:",e.peerConnection.connectionState),"connected"===e.peerConnection.connectionState?console.log("üéâ Conexi√≥n WebRTC establecida!"):"failed"!==e.peerConnection.connectionState&&"disconnected"!==e.peerConnection.connectionState||(console.log("Conexi√≥n perdida"),e.cleanupCall())},this.peerConnection.ontrack=function(t){console.log("üîä Stream remoto recibido!"),e.remoteStream=t.streams[0];var n=document.getElementById("remoteAudio");n||((n=document.createElement("audio")).id="remoteAudio",n.autoplay=!0,document.body.appendChild(n)),n.srcObject=e.remoteStream,console.log("‚úì Audio remoto conectado")},console.log("‚úì RTCPeerConnection creado")}},{key:"showCallIndicator",value:function(){var e=document.getElementById("callIndicator");e&&(e.style.display="flex")}},{key:"hideCallIndicator",value:function(){var e=document.getElementById("callIndicator");e&&(e.style.display="none")}},{key:"startCallTimer",value:function(){var e=this;this.callStartTime=Date.now(),this.callTimerInterval=setInterval(function(){var t=Math.floor((Date.now()-e.callStartTime)/1e3),n=Math.floor(t/60).toString().padStart(2,"0"),r=(t%60).toString().padStart(2,"0"),o=document.getElementById("callTimer");o&&(o.textContent="".concat(n,":").concat(r))},1e3)}},{key:"endCall",value:function(){console.log("=== Terminando llamada WebRTC ==="),this.callPeer&&this.app.ws&&this.app.ws.readyState===WebSocket.OPEN&&this.app.ws.send(JSON.stringify({type:"call-end",to:this.callPeer,callId:this.currentCallId}));var e=this.callStartTime?Math.floor((Date.now()-this.callStartTime)/1e3):0,t=Math.floor(e/60),n=e%60,r="".concat(t,":").concat(n.toString().padStart(2,"0"));this.callPeer&&this.app.ui.displayMessage({from:this.app.username,to:this.callPeer,message:"üìû Llamada finalizada (".concat(r,")"),type:"call",timestamp:(new Date).toISOString()}),console.log("‚úì Llamada terminada, duraci√≥n:",r),this.cleanupCall()}},{key:"cleanupCall",value:function(){console.log("Limpiando recursos de llamada..."),this.peerConnection&&(this.peerConnection.close(),this.peerConnection=null),this.localStream&&(this.localStream.getTracks().forEach(function(e){e.stop(),console.log("Track local detenido:",e.kind)}),this.localStream=null),this.remoteStream&&(this.remoteStream.getTracks().forEach(function(e){return e.stop()}),this.remoteStream=null);var e=document.getElementById("remoteAudio");e&&(e.srcObject=null),this.hideCallIndicator(),this.callTimerInterval&&(clearInterval(this.callTimerInterval),this.callTimerInterval=null),this.isInCall=!1,this.callPeer=null,this.currentCallId=null,this.pendingCandidates=[],this.updateCallUI(!1),console.log("‚úì Recursos de llamada limpiados")}},{key:"updateCallUI",value:function(e){var t=document.getElementById("callBtn");t&&(e?(t.classList.add("in-call"),t.innerHTML="üìû Colgar"):(t.classList.remove("in-call"),t.innerHTML="üìû Llamar"))}}],t&&l(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t,n,o,i,s}()},300:(e,t)=>{function n(e){return n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},n(e)}function r(){var e,t,n="function"==typeof Symbol?Symbol:{},a=n.iterator||"@@iterator",i=n.toStringTag||"@@toStringTag";function s(n,r,a,i){var s=r&&r.prototype instanceof l?r:l,u=Object.create(s.prototype);return o(u,"_invoke",function(n,r,o){var a,i,s,l=0,u=o||[],p=!1,d={p:0,n:0,v:e,a:f,f:f.bind(e,4),d:function(t,n){return a=t,i=0,s=e,d.n=n,c}};function f(n,r){for(i=n,s=r,t=0;!p&&l&&!o&&t<u.length;t++){var o,a=u[t],f=d.p,m=a[2];n>3?(o=m===r)&&(s=a[(i=a[4])?5:(i=3,3)],a[4]=a[5]=e):a[0]<=f&&((o=n<2&&f<a[1])?(i=0,d.v=r,d.n=a[1]):f<m&&(o=n<3||a[0]>r||r>m)&&(a[4]=n,a[5]=r,d.n=m,i=0))}if(o||n>1)return c;throw p=!0,r}return function(o,u,m){if(l>1)throw TypeError("Generator is already running");for(p&&1===u&&f(u,m),i=u,s=m;(t=i<2?e:s)||!p;){a||(i?i<3?(i>1&&(d.n=-1),f(i,s)):d.n=s:d.v=s);try{if(l=2,a){if(i||(o="next"),t=a[o]){if(!(t=t.call(a,s)))throw TypeError("iterator result is not an object");if(!t.done)return t;s=t.value,i<2&&(i=0)}else 1===i&&(t=a.return)&&t.call(a),i<2&&(s=TypeError("The iterator does not provide a '"+o+"' method"),i=1);a=e}else if((t=(p=d.n<0)?s:n.call(r,d))!==c)break}catch(t){a=e,i=1,s=t}finally{l=1}}return{value:t,done:p}}}(n,a,i),!0),u}var c={};function l(){}function u(){}function p(){}t=Object.getPrototypeOf;var d=[][a]?t(t([][a]())):(o(t={},a,function(){return this}),t),f=p.prototype=l.prototype=Object.create(d);function m(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,p):(e.__proto__=p,o(e,i,"GeneratorFunction")),e.prototype=Object.create(f),e}return u.prototype=p,o(f,"constructor",p),o(p,"constructor",u),u.displayName="GeneratorFunction",o(p,i,"GeneratorFunction"),o(f),o(f,i,"Generator"),o(f,a,function(){return this}),o(f,"toString",function(){return"[object Generator]"}),(r=function(){return{w:s,m}})()}function o(e,t,n,r){var a=Object.defineProperty;try{a({},"",{})}catch(e){a=0}o=function(e,t,n,r){function i(t,n){o(e,t,function(e){return this._invoke(t,n,e)})}t?a?a(e,t,{value:n,enumerable:!r,configurable:!r,writable:!r}):e[t]=n:(i("next",0),i("throw",1),i("return",2))},o(e,t,n,r)}function a(e,t,n,r,o,a,i){try{var s=e[a](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,o)}function i(e){return function(){var t=this,n=arguments;return new Promise(function(r,o){var i=e.apply(t,n);function s(e){a(i,r,o,s,c,"next",e)}function c(e){a(i,r,o,s,c,"throw",e)}s(void 0)})}}function s(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,c(r.key),r)}}function c(e){var t=function(e){if("object"!=n(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var r=t.call(e,"string");if("object"!=n(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==n(t)?t:t+""}Object.defineProperty(t,"__esModule",{value:!0}),t.MessageHandler=void 0,t.MessageHandler=function(){return e=function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.app=t},t=[{key:"sendMessage",value:(o=i(r().m(function e(){var t,n,o,a,i,s;return r().w(function(e){for(;;)switch(e.p=e.n){case 0:if(t=document.getElementById("messageInput"),!(n=t.value.trim())||!this.app.targetUser){e.n=6;break}return o={from:this.app.username,to:this.app.targetUser,message:n,timestamp:Date.now(),isGroup:this.app.isGroupChat,type:"text"},this.app.ui.displayMessage(o),t.value="",e.p=1,console.log("üì§ [Cliente] Enviando mensaje: ".concat(this.app.username," -> ").concat(this.app.targetUser)),e.n=2,fetch("".concat(this.app.API_URL,"/sendMessage"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({from:this.app.username,to:this.app.targetUser,message:n,isGroup:this.app.isGroupChat})});case 2:if((a=e.v).ok){e.n=3;break}throw new Error("HTTP error! status: ".concat(a.status));case 3:return e.n=4,a.json();case 4:i=e.v,console.log("‚úÖ Mensaje enviado, respuesta:",i),e.n=6;break;case 5:e.p=5,s=e.v,console.error("‚ùå Error enviando mensaje:",s),alert("Error al enviar mensaje: "+s.message);case 6:return e.a(2)}},e,this,[[1,5]])})),function(){return o.apply(this,arguments)})},{key:"handleNewMessage",value:function(e){if(console.log("üì® [Cliente] Nuevo mensaje recibido:",e),console.log("   Usuario actual:",this.app.username),console.log("   TargetUser:",this.app.targetUser),console.log("   Mensaje from:",e.from,"to:",e.to,"isGroup:",e.isGroup),e&&e.from&&e.to){var t,n=String(e.from||"").trim(),r=String(e.to||"").trim(),o=String(this.app.targetUser||"").trim(),a=String(this.app.username||"").trim(),i=e.isGroup||!1;t=o&&""!==o?i?r===o:n===o&&r===a||n===a&&r===o||(n===a||r===a)&&(n===o||r===o):r===a||n===a,console.log("   ¬øEs relevante para el chat actual?",t),console.log("   Comparaci√≥n:",{msgFrom:n,msgTo:r,targetUser:o,username:a,isGroup:i,isFromTargetToMe:o&&!i?n===o&&r===a:"N/A",isFromMeToTarget:o&&!i?n===a&&r===o:"N/A",involvesMe:o?n===a||r===a:"N/A",involvesTarget:o?n===o||r===o:"N/A"}),t?(console.log("   ‚úÖ Mostrando mensaje en el chat"),this.app.ui.displayMessage(e)):(console.log("   ‚ö†Ô∏è  Mensaje no es relevante para el chat actual"),console.log("   Valores exactos:",{msgFrom:'"'.concat(n,'"'),msgTo:'"'.concat(r,'"'),targetUser:'"'.concat(o,'"'),username:'"'.concat(a,'"'),msgFromLength:n.length,targetUserLength:o.length,usernameLength:a.length}),r===a&&n!==a&&console.log("   üì¨ Mensaje recibido pero chat no abierto - mostrando notificaci√≥n")),n!==a&&this.showNotification(e)}else console.error("‚ö†Ô∏è  Mensaje inv√°lido recibido:",e)}},{key:"showNotification",value:function(e){document.hidden&&(document.title="üí¨ Nuevo mensaje de ".concat(e.from),setTimeout(function(){document.title="Chat App"},3e3))}},{key:"loadHistory",value:(n=i(r().m(function e(t){var n,o,a,i;return r().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,fetch("".concat(this.app.API_URL,"/getHistory"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({target:t,from:this.app.username,isGroup:this.app.isGroupChat})});case 1:return n=e.v,e.n=2,n.json();case 2:o=e.v,a=[],o.messages&&Array.isArray(o.messages)&&(a=o.messages.map(function(e){if("string"==typeof e)try{return JSON.parse(e)}catch(e){return null}return e}).filter(function(e){return null!==e})),this.app.ui.displayHistory(a),e.n=4;break;case 3:e.p=3,i=e.v,console.error("Error cargando historial:",i);case 4:return e.a(2)}},e,this,[[0,3]])})),function(e){return n.apply(this,arguments)})}],t&&s(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t,n,o}()},742:(e,t)=>{function n(e){return n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},n(e)}function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,o(r.key),r)}}function o(e){var t=function(e){if("object"!=n(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var r=t.call(e,"string");if("object"!=n(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==n(t)?t:t+""}Object.defineProperty(t,"__esModule",{value:!0}),t.UIHandler=void 0,t.UIHandler=function(){return e=function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.app=t,this.colors=["#FF6B6B","#4ECDC4","#45B7D1","#96CEB4","#FFEAA7","#DDA0DD","#98D8C8","#F7DC6F","#BB8FCE","#85C1E9"]},t=[{key:"displayMessage",value:function(e){var t=document.getElementById("messagesContainer");if(t){var n=t.querySelectorAll(".message"),r=String(e.message||e.content||"").trim(),o=e.timestamp?"string"==typeof e.timestamp?parseInt(e.timestamp):e.timestamp:Date.now(),a=String(e.from||"").trim();if(a)for(var i=n.length-1;i>=Math.max(0,n.length-20);i--){var s=n[i],c=String(s.dataset.from||"").trim(),l=String(s.dataset.message||"").trim(),u=s.dataset.timestamp?parseInt(s.dataset.timestamp):0;if(c===a&&l===r&&r.length>0&&Math.abs(u-o)<2e3)return console.log("‚ö†Ô∏è  Mensaje duplicado detectado, ignorando"),console.log("   Existente: from=".concat(c,', msg="').concat(l.substring(0,30),'...", time=').concat(u)),void console.log("   Nuevo: from=".concat(a,', msg="').concat(r.substring(0,30),'...", time=').concat(o))}console.log("‚úÖ Agregando nuevo mensaje al chat:",a,"->",e.to);var p=this.createMessageElement(e);t.appendChild(p),t.scrollTop=t.scrollHeight}else console.warn("‚ö†Ô∏è  No se encontr√≥ el contenedor de mensajes")}},{key:"displayHistory",value:function(e){var t=this,n=document.getElementById("messagesContainer");n&&(n.innerHTML="",Array.isArray(e)&&e.length>0&&e.forEach(function(e){try{var r="string"==typeof e?JSON.parse(e):e;r&&r.from&&n.appendChild(t.createMessageElement(r))}catch(t){console.error("Error parseando mensaje:",t,e)}}),n.scrollTop=n.scrollHeight)}},{key:"createMessageElement",value:function(e){var t=e.from===this.app.username,n=document.createElement("div");n.className="message ".concat(t?"right":"left"),n.dataset.from=e.from,n.dataset.message=e.message||e.content||"";var r=e.timestamp?"string"==typeof e.timestamp?parseInt(e.timestamp):e.timestamp:Date.now();n.dataset.timestamp=r.toString();var o,a="";if("audio"===e.type&&e.audioData){var i=e.audioData;i.startsWith("data:")||(i="data:audio/webm;base64,".concat(i)),a='\n                <div class="audio-message">\n                    <span class="audio-icon">üéµ</span>\n                    <audio controls>\n                        <source src="'.concat(i,'" type="audio/webm">\n                        Tu navegador no soporta audio.\n                    </audio>\n                </div>\n            ')}else a="call"===e.type?'<div class="call-message">üìû '.concat(this.escapeHtml(e.message||e.content),"</div>"):'<div class="text">'.concat(this.escapeHtml(e.message||e.content),"</div>");return o=e.timestamp?"string"==typeof e.timestamp?new Date(parseInt(e.timestamp)).toLocaleTimeString():new Date(e.timestamp).toLocaleTimeString():(new Date).toLocaleTimeString(),n.innerHTML='\n            <div class="avatar" style="background-color:'.concat(this.getAvatarColor(e.from),'">\n                ').concat(e.from[0].toUpperCase(),'\n            </div>\n            <div class="text-wrapper">\n                ').concat(t?"":'<div class="user-name">'.concat(this.escapeHtml(e.from),"</div>"),"\n                ").concat(a,'\n                <div class="timestamp">').concat(o,"</div>\n            </div>"),n}},{key:"updateChatInterface",value:function(){document.getElementById("chatTarget").textContent=this.app.targetUser,document.getElementById("groupBadge").style.display=this.app.isGroupChat?"inline-block":"none";var e=document.getElementById("messageInputWrapper");this.app.targetUser?e.style.display="flex":e.style.display="none",this.app.loadUsers(),this.app.loadGroups()}},{key:"updateUserList",value:function(e){var t=this,n=document.getElementById("usersList");n.innerHTML="",e&&0!==e.length?e.forEach(function(e){var r=document.createElement("div");r.className="user-item",e!==t.app.targetUser||t.app.isGroupChat||r.classList.add("active"),r.innerHTML='<div class="avatar" style="background-color:'.concat(t.getAvatarColor(e),'">').concat(e[0].toUpperCase(),"</div><span>").concat(e,"</span>"),r.onclick=function(){return t.app.selectUser(e)},n.appendChild(r)}):n.innerHTML='<p style="color:#95a5a6;font-size:12px;padding:10px;">No hay usuarios</p>'}},{key:"updateGroupList",value:function(e){var t=this,n=document.getElementById("groupsList");n.innerHTML="",e&&0!==e.length?e.forEach(function(e){var r=t.createGroupElement(e);n.appendChild(r)}):n.innerHTML='<p style="color:#95a5a6;font-size:12px;padding:10px;">No hay grupos</p>'}},{key:"addGroupToList",value:function(e){var t=document.getElementById("groupsList");if(t){var n=Array.from(t.children).find(function(t){var n=t.querySelector("span");return n&&n.textContent.trim()===e});if(!n){var r=t.querySelector("p");r&&r.remove();var o=this.createGroupElement(e);t.appendChild(o)}}}},{key:"removeGroupFromList",value:function(e){var t=document.getElementById("groupsList");if(t){var n=Array.from(t.children).find(function(t){var n=t.querySelector("span");return n&&n.textContent.trim()===e});n&&n.remove(),0===t.children.length&&(t.innerHTML='<p style="color:#95a5a6;font-size:12px;padding:10px;">No hay grupos</p>')}}},{key:"createGroupElement",value:function(e){var t=this,n=document.createElement("div");return n.className="group-item",e===this.app.targetUser&&this.app.isGroupChat&&n.classList.add("active"),n.innerHTML='<div class="group-avatar">#</div><span>'.concat(e,"</span>"),n.onclick=function(){return t.app.selectGroup(e)},n}},{key:"updateConnectionStatus",value:function(e){var t=document.getElementById("connectionStatus");t&&(t.className=e?"status-connected":"status-disconnected",t.textContent=e?"‚óè Conectado":"‚óã Desconectado")}},{key:"getAvatarColor",value:function(e){return this.colors[e.charCodeAt(0)%this.colors.length]}},{key:"escapeHtml",value:function(e){if(!e)return"";var t=document.createElement("div");return t.textContent=e,t.innerHTML}}],t&&r(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t}()},848:(e,t)=>{function n(e){return n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},n(e)}function r(){var e,t,n="function"==typeof Symbol?Symbol:{},a=n.iterator||"@@iterator",i=n.toStringTag||"@@toStringTag";function s(n,r,a,i){var s=r&&r.prototype instanceof l?r:l,u=Object.create(s.prototype);return o(u,"_invoke",function(n,r,o){var a,i,s,l=0,u=o||[],p=!1,d={p:0,n:0,v:e,a:f,f:f.bind(e,4),d:function(t,n){return a=t,i=0,s=e,d.n=n,c}};function f(n,r){for(i=n,s=r,t=0;!p&&l&&!o&&t<u.length;t++){var o,a=u[t],f=d.p,m=a[2];n>3?(o=m===r)&&(s=a[(i=a[4])?5:(i=3,3)],a[4]=a[5]=e):a[0]<=f&&((o=n<2&&f<a[1])?(i=0,d.v=r,d.n=a[1]):f<m&&(o=n<3||a[0]>r||r>m)&&(a[4]=n,a[5]=r,d.n=m,i=0))}if(o||n>1)return c;throw p=!0,r}return function(o,u,m){if(l>1)throw TypeError("Generator is already running");for(p&&1===u&&f(u,m),i=u,s=m;(t=i<2?e:s)||!p;){a||(i?i<3?(i>1&&(d.n=-1),f(i,s)):d.n=s:d.v=s);try{if(l=2,a){if(i||(o="next"),t=a[o]){if(!(t=t.call(a,s)))throw TypeError("iterator result is not an object");if(!t.done)return t;s=t.value,i<2&&(i=0)}else 1===i&&(t=a.return)&&t.call(a),i<2&&(s=TypeError("The iterator does not provide a '"+o+"' method"),i=1);a=e}else if((t=(p=d.n<0)?s:n.call(r,d))!==c)break}catch(t){a=e,i=1,s=t}finally{l=1}}return{value:t,done:p}}}(n,a,i),!0),u}var c={};function l(){}function u(){}function p(){}t=Object.getPrototypeOf;var d=[][a]?t(t([][a]())):(o(t={},a,function(){return this}),t),f=p.prototype=l.prototype=Object.create(d);function m(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,p):(e.__proto__=p,o(e,i,"GeneratorFunction")),e.prototype=Object.create(f),e}return u.prototype=p,o(f,"constructor",p),o(p,"constructor",u),u.displayName="GeneratorFunction",o(p,i,"GeneratorFunction"),o(f),o(f,i,"Generator"),o(f,a,function(){return this}),o(f,"toString",function(){return"[object Generator]"}),(r=function(){return{w:s,m}})()}function o(e,t,n,r){var a=Object.defineProperty;try{a({},"",{})}catch(e){a=0}o=function(e,t,n,r){function i(t,n){o(e,t,function(e){return this._invoke(t,n,e)})}t?a?a(e,t,{value:n,enumerable:!r,configurable:!r,writable:!r}):e[t]=n:(i("next",0),i("throw",1),i("return",2))},o(e,t,n,r)}function a(e,t,n,r,o,a,i){try{var s=e[a](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,o)}function i(e){return function(){var t=this,n=arguments;return new Promise(function(r,o){var i=e.apply(t,n);function s(e){a(i,r,o,s,c,"next",e)}function c(e){a(i,r,o,s,c,"throw",e)}s(void 0)})}}function s(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,c(r.key),r)}}function c(e){var t=function(e){if("object"!=n(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var r=t.call(e,"string");if("object"!=n(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==n(t)?t:t+""}Object.defineProperty(t,"__esModule",{value:!0}),t.AudioHandler=void 0,t.AudioHandler=function(){return e=function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.app=t,this.isRecording=!1,this.mediaRecorder=null,this.audioChunks=[],this.currentAudioStream=null},t=[{key:"sendVoiceNote",value:(n=i(r().m(function e(){var t,n,o,a,s=this;return r().w(function(e){for(;;)switch(e.p=e.n){case 0:if(this.app.targetUser){e.n=1;break}return alert("Selecciona un destinatario primero"),e.a(2);case 1:return console.log("Iniciando grabaci√≥n de voz..."),e.p=2,e.n=3,navigator.mediaDevices.getUserMedia({audio:!0});case 3:t=e.v,console.log("Micr√≥fono accedido correctamente"),n="audio/webm",MediaRecorder.isTypeSupported(n)||(n="audio/ogg",MediaRecorder.isTypeSupported(n)||(n="audio/mp4",MediaRecorder.isTypeSupported(n)||(n=""))),console.log("Usando mimeType:",n||"default"),o=n?{mimeType:n}:{},this.mediaRecorder=new MediaRecorder(t,o),this.audioChunks=[],this.currentAudioStream=t,this.mediaRecorder.ondataavailable=function(e){e.data.size>0&&s.audioChunks.push(e.data)},this.mediaRecorder.onstop=i(r().m(function e(){var t,o;return r().w(function(e){for(;;)switch(e.n){case 0:console.log("Grabaci√≥n detenida, procesando audio..."),t=new Blob(s.audioChunks,{type:n||"audio/webm"}),console.log("Audio blob creado, tama√±o:",t.size),(o=new FileReader).onloadend=i(r().m(function e(){var t,a,i,c,l;return r().w(function(e){for(;;)switch(e.p=e.n){case 0:return t=o.result.split(",")[1],console.log("Audio convertido a Base64, longitud:",null==t?void 0:t.length),a="data:".concat(n||"audio/webm",";base64,").concat(t),i={from:s.app.username,to:s.app.targetUser,message:"[Nota de voz]",timestamp:Date.now(),isGroup:s.app.isGroupChat,type:"audio",audioData:a},s.app.ui.displayMessage(i),e.p=1,e.n=2,fetch("".concat(s.app.API_URL,"/sendVoiceNote"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({from:s.app.username,to:s.app.targetUser,audioData:t,isGroup:s.app.isGroupChat})});case 2:c=e.v,console.log("Nota de voz enviada, respuesta:",c.status),e.n=4;break;case 3:e.p=3,l=e.v,console.error("Error enviando nota de voz:",l),alert("Error al enviar nota de voz");case 4:return e.a(2)}},e,null,[[1,3]])})),o.readAsDataURL(t),s.currentAudioStream&&(s.currentAudioStream.getTracks().forEach(function(e){return e.stop()}),s.currentAudioStream=null);case 1:return e.a(2)}},e)})),this.mediaRecorder.start(),this.isRecording=!0,this.updateRecordingUI(!0),setTimeout(function(){s.isRecording&&s.stopRecording()},6e4),e.n=5;break;case 4:e.p=4,a=e.v,console.error("Error accediendo al micr√≥fono:",a),alert("Error al acceder al micr√≥fono. Aseg√∫rate de dar permisos.");case 5:return e.a(2)}},e,this,[[2,4]])})),function(){return n.apply(this,arguments)})},{key:"stopRecording",value:function(){this.mediaRecorder&&this.isRecording&&(this.mediaRecorder.stop(),this.isRecording=!1,this.updateRecordingUI(!1))}},{key:"updateRecordingUI",value:function(e){var t=document.getElementById("voiceNoteBtn");t&&(e?(t.classList.add("recording"),t.innerHTML="‚èπ Detener"):(t.classList.remove("recording"),t.innerHTML="üé§ Voz"))}}],t&&s(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t,n}()}},t={};function n(r){var o=t[r];if(void 0!==o)return o.exports;var a=t[r]={exports:{}};return e[r](a,a.exports,n),a.exports}var r=n(300),o=n(848),a=n(33),i=n(742);function s(e){return s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},s(e)}function c(){var e,t,n="function"==typeof Symbol?Symbol:{},r=n.iterator||"@@iterator",o=n.toStringTag||"@@toStringTag";function a(n,r,o,a){var c=r&&r.prototype instanceof s?r:s,u=Object.create(c.prototype);return l(u,"_invoke",function(n,r,o){var a,s,c,l=0,u=o||[],p=!1,d={p:0,n:0,v:e,a:f,f:f.bind(e,4),d:function(t,n){return a=t,s=0,c=e,d.n=n,i}};function f(n,r){for(s=n,c=r,t=0;!p&&l&&!o&&t<u.length;t++){var o,a=u[t],f=d.p,m=a[2];n>3?(o=m===r)&&(c=a[(s=a[4])?5:(s=3,3)],a[4]=a[5]=e):a[0]<=f&&((o=n<2&&f<a[1])?(s=0,d.v=r,d.n=a[1]):f<m&&(o=n<3||a[0]>r||r>m)&&(a[4]=n,a[5]=r,d.n=m,s=0))}if(o||n>1)return i;throw p=!0,r}return function(o,u,m){if(l>1)throw TypeError("Generator is already running");for(p&&1===u&&f(u,m),s=u,c=m;(t=s<2?e:c)||!p;){a||(s?s<3?(s>1&&(d.n=-1),f(s,c)):d.n=c:d.v=c);try{if(l=2,a){if(s||(o="next"),t=a[o]){if(!(t=t.call(a,c)))throw TypeError("iterator result is not an object");if(!t.done)return t;c=t.value,s<2&&(s=0)}else 1===s&&(t=a.return)&&t.call(a),s<2&&(c=TypeError("The iterator does not provide a '"+o+"' method"),s=1);a=e}else if((t=(p=d.n<0)?c:n.call(r,d))!==i)break}catch(t){a=e,s=1,c=t}finally{l=1}}return{value:t,done:p}}}(n,o,a),!0),u}var i={};function s(){}function u(){}function p(){}t=Object.getPrototypeOf;var d=[][r]?t(t([][r]())):(l(t={},r,function(){return this}),t),f=p.prototype=s.prototype=Object.create(d);function m(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,p):(e.__proto__=p,l(e,o,"GeneratorFunction")),e.prototype=Object.create(f),e}return u.prototype=p,l(f,"constructor",p),l(p,"constructor",u),u.displayName="GeneratorFunction",l(p,o,"GeneratorFunction"),l(f),l(f,o,"Generator"),l(f,r,function(){return this}),l(f,"toString",function(){return"[object Generator]"}),(c=function(){return{w:a,m}})()}function l(e,t,n,r){var o=Object.defineProperty;try{o({},"",{})}catch(e){o=0}l=function(e,t,n,r){function a(t,n){l(e,t,function(e){return this._invoke(t,n,e)})}t?o?o(e,t,{value:n,enumerable:!r,configurable:!r,writable:!r}):e[t]=n:(a("next",0),a("throw",1),a("return",2))},l(e,t,n,r)}function u(e,t,n,r,o,a,i){try{var s=e[a](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,o)}function p(e){return function(){var t=this,n=arguments;return new Promise(function(r,o){var a=e.apply(t,n);function i(e){u(a,r,o,i,s,"next",e)}function s(e){u(a,r,o,i,s,"throw",e)}i(void 0)})}}function d(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,f(r.key),r)}}function f(e){var t=function(e){if("object"!=s(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,"string");if("object"!=s(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==s(t)?t:t+""}var m,h=function(){return e=function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.username="",this.targetUser="",this.isGroupChat=!1,this.API_URL="http://192.168.131.133:3000",this.WS_URL="ws://192.168.131.133:3000",this.ws=null,this.reconnectAttempts=0,this.maxReconnectAttempts=5,this.ui=new i.UIHandler(this),this.messages=new r.MessageHandler(this),this.audio=new o.AudioHandler(this),this.webrtc=new a.WebRTCHandler(this),this.init()},t=[{key:"init",value:function(){this.getUsername(),this.setupEventListeners()}},{key:"getUsername",value:function(){this.username=prompt("Ingresa tu nombre:")||"Usuario"+Math.floor(1e3*Math.random()),document.getElementById("usernameDisplay").textContent=this.username,document.getElementById("userAvatar").textContent=this.username[0].toUpperCase(),document.getElementById("userAvatar").style.backgroundColor=this.ui.getAvatarColor(this.username),this.registerUser(),this.refreshLists(),this.connectWebSocket()}},{key:"registerUser",value:(g=p(c().m(function e(){var t,n,r;return c().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,fetch("".concat(this.API_URL,"/register"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:this.username})});case 1:return t=e.v,e.n=2,t.json();case 2:n=e.v,console.log("Usuario registrado:",n),e.n=4;break;case 3:e.p=3,r=e.v,console.error("Error registrando usuario",r);case 4:return e.a(2)}},e,this,[[0,3]])})),function(){return g.apply(this,arguments)})},{key:"connectWebSocket",value:function(){var e=this;try{this.ws=new WebSocket(this.WS_URL),this.ws.onopen=function(){console.log("WebSocket conectado"),e.reconnectAttempts=0,e.ws.send(JSON.stringify({type:"register",username:e.username})),e.ui.updateConnectionStatus(!0)},this.ws.onmessage=function(t){try{var n=JSON.parse(t.data);console.log("üì• [WebSocket] Mensaje recibido:",n.type),e.handleWebSocketMessage(n)}catch(e){console.error("‚ùå Error parseando mensaje WebSocket:",e),console.error("   Datos recibidos:",t.data)}},this.ws.onclose=function(){console.log("WebSocket desconectado"),e.ui.updateConnectionStatus(!1),e.attemptReconnect()},this.ws.onerror=function(t){console.error("Error WebSocket:",t),e.ui.updateConnectionStatus(!1)}}catch(e){console.error("Error conectando WebSocket:",e),this.attemptReconnect()}}},{key:"attemptReconnect",value:function(){var e=this;this.reconnectAttempts<this.maxReconnectAttempts?(this.reconnectAttempts++,console.log("Intentando reconexi√≥n ".concat(this.reconnectAttempts,"/").concat(this.maxReconnectAttempts,"...")),setTimeout(function(){return e.connectWebSocket()},2e3*this.reconnectAttempts)):console.log("M√°ximo de intentos de reconexi√≥n alcanzado")}},{key:"handleWebSocketMessage",value:function(e){switch(console.log("Mensaje WebSocket recibido:",e),e.type){case"registered":console.log("Registrado en WebSocket como:",e.username);break;case"newMessage":this.messages.handleNewMessage(e.message);break;case"groupCreated":console.log("Nuevo grupo creado:",e.groupName),this.loadGroups();break;case"userRegistered":console.log("Nuevo usuario registrado:",e.username),this.loadUsers();break;case"userDisconnected":console.log("Usuario desconectado:",e.username),this.loadUsers();break;case"incomingCall":console.log("handleIncomingCall (legacy):",e);break;case"call-offer":this.webrtc.handleCallOffer(e);break;case"call-answer":this.webrtc.handleCallAnswer(e);break;case"ice-candidate":this.webrtc.handleRemoteIceCandidate(e);break;case"call-rejected":this.webrtc.handleCallRejected(e);break;case"call-ended":this.webrtc.handleCallEnded(e);break;case"call-failed":this.webrtc.handleCallFailed(e);break;default:console.log("Tipo de mensaje no reconocido:",e.type)}}},{key:"sendMessage",value:(y=p(c().m(function e(){return c().w(function(e){for(;;)if(0===e.n)return e.a(2,this.messages.sendMessage())},e,this)})),function(){return y.apply(this,arguments)})},{key:"sendVoiceNote",value:(h=p(c().m(function e(){return c().w(function(e){for(;;)if(0===e.n)return e.a(2,this.audio.sendVoiceNote())},e,this)})),function(){return h.apply(this,arguments)})},{key:"stopRecording",value:function(){return this.audio.stopRecording()}},{key:"startCall",value:(m=p(c().m(function e(){return c().w(function(e){for(;;)if(0===e.n)return e.a(2,this.webrtc.startCall())},e,this)})),function(){return m.apply(this,arguments)})},{key:"endCall",value:function(){return this.webrtc.endCall()}},{key:"createGroup",value:(f=p(c().m(function e(){var t,n,r,o,a;return c().w(function(e){for(;;)switch(e.p=e.n){case 0:if(t=document.getElementById("newGroupName"),n=t.value.trim(),console.log("createGroup interno llamado, nombre:",n),!n){e.n=6;break}return this.ui.addGroupToList(n),t.value="",e.p=1,e.n=2,fetch("".concat(this.API_URL,"/createGroup"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({groupName:n})});case 2:return r=e.v,e.n=3,r.json();case 3:o=e.v,console.log("Grupo creado, respuesta:",o),e.n=5;break;case 4:e.p=4,a=e.v,console.error("Error creando grupo:",a),alert("Error al crear grupo: "+a.message),this.ui.removeGroupFromList(n);case 5:e.n=7;break;case 6:alert("Por favor ingresa un nombre para el grupo");case 7:return e.a(2)}},e,this,[[1,4]])})),function(){return f.apply(this,arguments)})},{key:"selectUser",value:function(e){e!==this.username&&(this.targetUser=e,this.isGroupChat=!1,this.ui.updateChatInterface(),this.messages.loadHistory(e))}},{key:"selectGroup",value:function(e){this.targetUser=e,this.isGroupChat=!0,this.ui.updateChatInterface(),this.messages.loadHistory(e)}},{key:"loadHistory",value:(u=p(c().m(function e(t){return c().w(function(e){for(;;)if(0===e.n)return e.a(2,this.messages.loadHistory(t))},e,this)})),function(e){return u.apply(this,arguments)})},{key:"refreshLists",value:(l=p(c().m(function e(){return c().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,this.loadGroups();case 1:return e.n=2,this.loadUsers();case 2:return e.a(2)}},e,this)})),function(){return l.apply(this,arguments)})},{key:"loadGroups",value:(s=p(c().m(function e(){var t,n,r,o;return c().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,fetch("".concat(this.API_URL,"/getGroups"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({})});case 1:return t=e.v,e.n=2,t.json();case 2:n=e.v,r=[],n&&n.groups?r=n.groups:n&&Array.isArray(n)&&(r=n),this.ui.updateGroupList(r),e.n=4;break;case 3:e.p=3,o=e.v,console.error("Error cargando grupos:",o);case 4:return e.a(2)}},e,this,[[0,3]])})),function(){return s.apply(this,arguments)})},{key:"loadUsers",value:(n=p(c().m(function e(){var t,n,r,o,a=this;return c().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,fetch("".concat(this.API_URL,"/getUsers"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({})});case 1:return t=e.v,e.n=2,t.json();case 2:n=e.v,r=[],n&&n.users?r=n.users:n&&Array.isArray(n)&&(r=n),r=r.filter(function(e){return e!==a.username}),this.ui.updateUserList(r),e.n=4;break;case 3:e.p=3,o=e.v,console.error("Error cargando usuarios:",o);case 4:return e.a(2)}},e,this,[[0,3]])})),function(){return n.apply(this,arguments)})},{key:"setupEventListeners",value:function(){var e=this;document.getElementById("messageInput").addEventListener("keypress",function(t){"Enter"===t.key&&e.sendMessage()}),setInterval(function(){e.loadUsers()},1e4)}},{key:"isRecording",get:function(){return this.audio.isRecording}},{key:"isInCall",get:function(){return this.webrtc.isInCall}}],t&&d(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t,n,s,l,u,f,m,h,y,g}();window.onload=function(){m=new h},window.sendMessage=function(){console.log("sendMessage llamado"),m?m.sendMessage():console.error("chatApp no inicializado")},window.createGroup=function(){console.log("createGroup llamado"),m?m.createGroup():console.error("chatApp no inicializado")},window.sendVoiceNote=function(){var e;console.log("sendVoiceNote llamado, isRecording:",null===(e=m)||void 0===e?void 0:e.isRecording),m?m.isRecording?m.stopRecording():m.sendVoiceNote():console.error("chatApp no inicializado")},window.startCall=function(){console.log("startCall llamado"),m?m.isInCall?m.endCall():m.startCall():console.error("chatApp no inicializado")}})();
//# sourceMappingURL=chat.js.map