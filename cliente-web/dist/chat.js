(()=>{class e{constructor(){this.username="",this.targetUser="",this.isGroupChat=!1,this.colors=["#FF6B6B","#4ECDC4","#45B7D1","#96CEB4","#FFEAA7","#DDA0DD","#98D8C8","#F7DC6F","#BB8FCE","#85C1E9"],this.API_URL="http://localhost:3000",this.WS_URL="ws://localhost:3000",this.ws=null,this.isRecording=!1,this.mediaRecorder=null,this.audioChunks=[],this.isInCall=!1,this.localStream=null,this.remoteStream=null,this.reconnectAttempts=0,this.maxReconnectAttempts=5,this.peerConnection=null,this.currentCallId=null,this.pendingCandidates=[],this.callPeer=null,this.iceServers={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun2.l.google.com:19302"}]},this.init()}init(){this.getUsername(),this.setupEventListeners()}getUsername(){this.username=prompt("Ingresa tu nombre:")||"Usuario"+Math.floor(1e3*Math.random()),document.getElementById("usernameDisplay").textContent=this.username,document.getElementById("userAvatar").textContent=this.username[0].toUpperCase(),document.getElementById("userAvatar").style.backgroundColor=this.getAvatarColor(this.username),this.registerUser(),this.refreshLists(),this.connectWebSocket()}async registerUser(){try{const e=await fetch(`${this.API_URL}/register`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:this.username})}),t=await e.json();console.log("Usuario registrado:",t)}catch(e){console.error("Error registrando usuario",e)}}connectWebSocket(){try{this.ws=new WebSocket(this.WS_URL),this.ws.onopen=()=>{console.log("WebSocket conectado"),this.reconnectAttempts=0,this.ws.send(JSON.stringify({type:"register",username:this.username})),this.updateConnectionStatus(!0)},this.ws.onmessage=e=>{try{const t=JSON.parse(e.data);this.handleWebSocketMessage(t)}catch(e){console.error("Error parseando mensaje WebSocket:",e)}},this.ws.onclose=()=>{console.log("WebSocket desconectado"),this.updateConnectionStatus(!1),this.attemptReconnect()},this.ws.onerror=e=>{console.error("Error WebSocket:",e),this.updateConnectionStatus(!1)}}catch(e){console.error("Error conectando WebSocket:",e),this.attemptReconnect()}}attemptReconnect(){this.reconnectAttempts<this.maxReconnectAttempts?(this.reconnectAttempts++,console.log(`Intentando reconexiÃ³n ${this.reconnectAttempts}/${this.maxReconnectAttempts}...`),setTimeout(()=>this.connectWebSocket(),2e3*this.reconnectAttempts)):console.log("MÃ¡ximo de intentos de reconexiÃ³n alcanzado")}handleWebSocketMessage(e){switch(console.log("Mensaje WebSocket recibido:",e),e.type){case"registered":console.log("Registrado en WebSocket como:",e.username);break;case"newMessage":this.handleNewMessage(e.message);break;case"groupCreated":console.log("Nuevo grupo creado:",e.groupName),this.loadGroups();break;case"incomingCall":this.handleIncomingCall(e);break;case"call-offer":this.handleCallOffer(e);break;case"call-answer":this.handleCallAnswer(e);break;case"ice-candidate":this.handleRemoteIceCandidate(e);break;case"call-rejected":this.handleCallRejected(e);break;case"call-ended":this.handleCallEnded(e);break;case"call-failed":this.handleCallFailed(e);break;default:console.log("Tipo de mensaje no reconocido:",e.type)}}handleNewMessage(e){this.isMessageRelevant(e)&&this.displayMessage(e),e.from!==this.username&&this.showNotification(e)}isMessageRelevant(e){return!!this.targetUser&&(e.isGroup?e.to===this.targetUser:e.from===this.targetUser&&e.to===this.username||e.from===this.username&&e.to===this.targetUser)}showNotification(e){document.hidden&&(document.title=`ðŸ’¬ Nuevo mensaje de ${e.from}`,setTimeout(()=>{document.title="Chat App"},3e3))}handleIncomingCall(e){console.log("handleIncomingCall (legacy):",e)}async handleCallOffer(e){const{from:t,offer:a,callId:o,isGroup:s}=e;if(console.log(`ðŸ“ž Oferta de llamada recibida de ${t}`),this.isInCall)this.ws.send(JSON.stringify({type:"call-reject",to:t,callId:o}));else if(confirm(`ðŸ“ž Llamada entrante de ${t}. Â¿Aceptar?`))try{this.callPeer=t,this.currentCallId=o,this.targetUser=t,this.isGroupChat=s||!1,this.updateChatInterface(),this.localStream=await navigator.mediaDevices.getUserMedia({audio:!0,video:!1}),console.log("âœ“ MicrÃ³fono activado"),this.createPeerConnection(),this.localStream.getTracks().forEach(e=>{this.peerConnection.addTrack(e,this.localStream)}),await this.peerConnection.setRemoteDescription(new RTCSessionDescription(a)),console.log("âœ“ Oferta remota establecida");for(const e of this.pendingCandidates)await this.peerConnection.addIceCandidate(new RTCIceCandidate(e));this.pendingCandidates=[];const e=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(e),console.log("âœ“ Respuesta SDP creada"),this.ws.send(JSON.stringify({type:"call-answer",to:t,answer:e,callId:o})),this.isInCall=!0,this.updateCallUI(!0),this.startCallTimer(),this.showCallIndicator(),this.displayMessage({from:t,to:this.username,message:"ðŸ“ž Llamada conectada",type:"call",timestamp:(new Date).toISOString()})}catch(e){console.error("Error aceptando llamada:",e),alert("Error al aceptar llamada: "+e.message),this.cleanupCall()}else this.ws.send(JSON.stringify({type:"call-reject",to:t,callId:o}))}async handleCallAnswer(e){const{from:t,answer:a}=e;console.log(`âœ… Respuesta de llamada recibida de ${t}`);try{await this.peerConnection.setRemoteDescription(new RTCSessionDescription(a)),console.log("âœ“ Respuesta remota establecida - Llamada conectada!"),this.displayMessage({from:this.username,to:t,message:"ðŸ“ž Llamada conectada",type:"call",timestamp:(new Date).toISOString()})}catch(e){console.error("Error procesando respuesta:",e)}}async handleRemoteIceCandidate(e){const{from:t,candidate:a}=e;if(a)try{this.peerConnection&&this.peerConnection.remoteDescription?(await this.peerConnection.addIceCandidate(new RTCIceCandidate(a)),console.log("âœ“ Candidato ICE aÃ±adido")):this.pendingCandidates.push(a)}catch(e){console.error("Error aÃ±adiendo candidato ICE:",e)}}handleCallRejected(e){console.log(`âŒ Llamada rechazada por ${e.from}`),alert(`${e.from} rechazÃ³ la llamada`),this.cleanupCall()}handleCallEnded(e){console.log(`ðŸ“´ Llamada terminada por ${e.from}`);const t="user_disconnected"===e.reason?"El usuario se desconectÃ³":"Llamada finalizada";this.displayMessage({from:e.from,to:this.username,message:`ðŸ“ž ${t}`,type:"call",timestamp:(new Date).toISOString()}),this.cleanupCall()}handleCallFailed(e){console.log(`âŒ Llamada fallida: ${e.reason}`),alert(`No se pudo conectar la llamada: ${e.to} no estÃ¡ disponible`),this.cleanupCall()}updateConnectionStatus(e){const t=document.getElementById("connectionStatus");t&&(t.className=e?"status-connected":"status-disconnected",t.textContent=e?"â— Conectado":"â—‹ Desconectado")}async sendMessage(){const e=document.getElementById("messageInput"),t=e.value.trim();if(t&&this.targetUser)try{await fetch(`${this.API_URL}/sendMessage`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({from:this.username,to:this.targetUser,message:t,isGroup:this.isGroupChat})}),e.value=""}catch(e){console.error("Error enviando mensaje:",e),alert("Error al enviar mensaje: "+e.message)}}async sendVoiceNote(){if(this.targetUser){console.log("Iniciando grabaciÃ³n de voz...");try{const e=await navigator.mediaDevices.getUserMedia({audio:!0});console.log("MicrÃ³fono accedido correctamente");let t="audio/webm";MediaRecorder.isTypeSupported(t)||(t="audio/ogg",MediaRecorder.isTypeSupported(t)||(t="audio/mp4",MediaRecorder.isTypeSupported(t)||(t=""))),console.log("Usando mimeType:",t||"default");const a=t?{mimeType:t}:{};this.mediaRecorder=new MediaRecorder(e,a),this.audioChunks=[],this.currentAudioStream=e,this.mediaRecorder.ondataavailable=e=>{e.data.size>0&&this.audioChunks.push(e.data)},this.mediaRecorder.onstop=async()=>{console.log("GrabaciÃ³n detenida, procesando audio...");const e=new Blob(this.audioChunks,{type:t||"audio/webm"});console.log("Audio blob creado, tamaÃ±o:",e.size);const a=new FileReader;a.onloadend=async()=>{const e=a.result.split(",")[1];console.log("Audio convertido a Base64, longitud:",e?.length);try{const t=await fetch(`${this.API_URL}/sendVoiceNote`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({from:this.username,to:this.targetUser,audioData:e,isGroup:this.isGroupChat})});console.log("Nota de voz enviada, respuesta:",t.status)}catch(e){console.error("Error enviando nota de voz:",e),alert("Error al enviar nota de voz")}},a.readAsDataURL(e),this.currentAudioStream&&(this.currentAudioStream.getTracks().forEach(e=>e.stop()),this.currentAudioStream=null)},this.mediaRecorder.start(),this.isRecording=!0,this.updateRecordingUI(!0),setTimeout(()=>{this.isRecording&&this.stopRecording()},6e4)}catch(e){console.error("Error accediendo al micrÃ³fono:",e),alert("Error al acceder al micrÃ³fono. AsegÃºrate de dar permisos.")}}else alert("Selecciona un destinatario primero")}stopRecording(){this.mediaRecorder&&this.isRecording&&(this.mediaRecorder.stop(),this.isRecording=!1,this.updateRecordingUI(!1))}updateRecordingUI(e){const t=document.getElementById("voiceNoteBtn");t&&(e?(t.classList.add("recording"),t.innerHTML="â¹ Detener"):(t.classList.remove("recording"),t.innerHTML="ðŸŽ¤ Voz"))}async startCall(){if(console.log("=== startCall (WebRTC) ==="),console.log("targetUser:",this.targetUser),console.log("isInCall:",this.isInCall),this.targetUser){if(this.isInCall)return console.log("Terminando llamada..."),void this.endCall();try{this.callPeer=this.targetUser,console.log("Solicitando acceso al micrÃ³fono..."),this.localStream=await navigator.mediaDevices.getUserMedia({audio:!0,video:!1}),console.log("âœ“ MicrÃ³fono activado"),this.createPeerConnection(),this.localStream.getTracks().forEach(e=>{this.peerConnection.addTrack(e,this.localStream)});const e=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(e),console.log("âœ“ Oferta SDP creada"),this.ws.send(JSON.stringify({type:"call-offer",to:this.targetUser,offer:e,isGroup:this.isGroupChat})),console.log("ðŸ“ž Llamando a",this.targetUser),this.isInCall=!0,this.updateCallUI(!0),this.startCallTimer(),this.showCallIndicator(),this.displayMessage({from:this.username,to:this.targetUser,message:"ðŸ“ž Llamando...",type:"call",timestamp:(new Date).toISOString()})}catch(e){console.error("Error iniciando llamada:",e),"NotAllowedError"===e.name?alert("âŒ Permiso de micrÃ³fono denegado."):"NotFoundError"===e.name?alert("âŒ No se encontrÃ³ micrÃ³fono."):alert("âŒ Error al iniciar llamada: "+e.message),this.cleanupCall()}}else alert("âš ï¸ Primero selecciona un usuario o grupo para llamar")}createPeerConnection(){console.log("Creando RTCPeerConnection..."),this.peerConnection=new RTCPeerConnection(this.iceServers),this.peerConnection.onicecandidate=e=>{e.candidate&&(console.log("Candidato ICE local generado"),this.ws.send(JSON.stringify({type:"ice-candidate",to:this.callPeer,candidate:e.candidate})))},this.peerConnection.onconnectionstatechange=()=>{console.log("Estado de conexiÃ³n:",this.peerConnection.connectionState),"connected"===this.peerConnection.connectionState?console.log("ðŸŽ‰ ConexiÃ³n WebRTC establecida!"):"failed"!==this.peerConnection.connectionState&&"disconnected"!==this.peerConnection.connectionState||(console.log("ConexiÃ³n perdida"),this.cleanupCall())},this.peerConnection.ontrack=e=>{console.log("ðŸ”Š Stream remoto recibido!"),this.remoteStream=e.streams[0];let t=document.getElementById("remoteAudio");t||(t=document.createElement("audio"),t.id="remoteAudio",t.autoplay=!0,document.body.appendChild(t)),t.srcObject=this.remoteStream,console.log("âœ“ Audio remoto conectado")},console.log("âœ“ RTCPeerConnection creado")}showCallIndicator(){const e=document.getElementById("callIndicator");e&&(e.style.display="flex")}hideCallIndicator(){const e=document.getElementById("callIndicator");e&&(e.style.display="none")}startCallTimer(){this.callStartTime=Date.now(),this.callTimerInterval=setInterval(()=>{const e=Math.floor((Date.now()-this.callStartTime)/1e3),t=Math.floor(e/60).toString().padStart(2,"0"),a=(e%60).toString().padStart(2,"0"),o=document.getElementById("callTimer");o&&(o.textContent=`${t}:${a}`)},1e3)}endCall(){console.log("=== Terminando llamada WebRTC ==="),this.callPeer&&this.ws&&this.ws.readyState===WebSocket.OPEN&&this.ws.send(JSON.stringify({type:"call-end",to:this.callPeer,callId:this.currentCallId}));const e=this.callStartTime?Math.floor((Date.now()-this.callStartTime)/1e3):0,t=`${Math.floor(e/60)}:${(e%60).toString().padStart(2,"0")}`;this.callPeer&&this.displayMessage({from:this.username,to:this.callPeer,message:`ðŸ“ž Llamada finalizada (${t})`,type:"call",timestamp:(new Date).toISOString()}),console.log("âœ“ Llamada terminada, duraciÃ³n:",t),this.cleanupCall()}cleanupCall(){console.log("Limpiando recursos de llamada..."),this.peerConnection&&(this.peerConnection.close(),this.peerConnection=null),this.localStream&&(this.localStream.getTracks().forEach(e=>{e.stop(),console.log("Track local detenido:",e.kind)}),this.localStream=null),this.remoteStream&&(this.remoteStream.getTracks().forEach(e=>e.stop()),this.remoteStream=null);const e=document.getElementById("remoteAudio");e&&(e.srcObject=null),this.hideCallIndicator(),this.callTimerInterval&&(clearInterval(this.callTimerInterval),this.callTimerInterval=null),this.isInCall=!1,this.callStartTime=null,this.currentCallId=null,this.callPeer=null,this.pendingCandidates=[],this.updateCallUI(!1),console.log("âœ“ Recursos de llamada limpiados")}updateCallUI(e){const t=document.getElementById("callBtn");t&&(e?(t.classList.add("in-call"),t.innerHTML="ðŸ“ž Colgar"):(t.classList.remove("in-call"),t.innerHTML="ðŸ“ž Llamar"))}async createGroup(){const e=document.getElementById("newGroupName"),t=e.value.trim();if(console.log("createGroup interno llamado, nombre:",t),t)try{const a=await fetch(`${this.API_URL}/createGroup`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({groupName:t})}),o=await a.json();console.log("Grupo creado, respuesta:",o),alert(`Grupo creado: ${t}`),e.value="",this.loadGroups()}catch(e){console.error("Error creando grupo:",e),alert("Error al crear grupo: "+e.message)}else alert("Por favor ingresa un nombre para el grupo")}selectUser(e){e!==this.username&&(this.targetUser=e,this.isGroupChat=!1,this.updateChatInterface(),this.loadHistory(e))}selectGroup(e){this.targetUser=e,this.isGroupChat=!0,this.updateChatInterface(),this.loadHistory(e)}async loadHistory(e){try{const t=await fetch(`${this.API_URL}/getHistory`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({target:e,from:this.username,isGroup:this.isGroupChat})}),a=await t.json();let o=[];a&&a.messages?o=a.messages:Array.isArray(a)&&(o=a),this.displayHistory(o)}catch(e){console.error("Error cargando historial:",e)}}async refreshLists(){await this.loadGroups(),await this.loadUsers()}async loadGroups(){try{const e=await fetch(`${this.API_URL}/getGroups`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({})}),t=await e.json();let a=[];t&&t.groups?a=t.groups:t&&Array.isArray(t)&&(a=t),this.updateGroupList(a)}catch(e){console.error("Error cargando grupos:",e)}}async loadUsers(){try{const e=await fetch(`${this.API_URL}/getUsers`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({})}),t=await e.json();let a=[];t&&t.users?a=t.users:t&&Array.isArray(t)&&(a=t),this.updateUserList(a)}catch(e){console.error("Error cargando usuarios:",e)}}updateUserList(e){const t=document.getElementById("usersList");t.innerHTML="",e.forEach(e=>{if(e!==this.username){const a=document.createElement("div");a.className="user-item",e!==this.targetUser||this.isGroupChat||a.classList.add("active"),a.innerHTML=`\n                    <div class="avatar" style="background-color: ${this.getAvatarColor(e)}">\n                        ${e[0].toUpperCase()}\n                    </div>\n                    <span>${e}</span>\n                `,a.onclick=()=>this.selectUser(e),t.appendChild(a)}})}updateGroupList(e){const t=document.getElementById("groupsList");t.innerHTML="",e&&0!==e.length?e.forEach(e=>{const a=document.createElement("div");a.className="group-item",e===this.targetUser&&this.isGroupChat&&a.classList.add("active"),a.innerHTML=`<div class="group-avatar">#</div><span>${e}</span>`,a.onclick=()=>this.selectGroup(e),t.appendChild(a)}):t.innerHTML='<p style="color:#95a5a6;font-size:12px;padding:10px;">No hay grupos</p>'}displayMessage(e){const t=document.getElementById("messagesContainer");if(!t)return;const a=t.querySelectorAll(".message");for(let t=a.length-1;t>=Math.max(0,a.length-5);t--){const o=a[t];if(o.dataset.from===e.from&&o.dataset.message===(e.message||e.content))return}const o=this.createMessageElement(e);t.appendChild(o),t.scrollTop=t.scrollHeight}displayHistory(e){const t=document.getElementById("messagesContainer");t&&(t.innerHTML="",Array.isArray(e)&&e.length>0&&e.forEach(e=>{try{let a="string"==typeof e?JSON.parse(e):e;a&&a.from&&t.appendChild(this.createMessageElement(a))}catch(t){console.error("Error parseando mensaje:",t,e)}}),t.scrollTop=t.scrollHeight)}createMessageElement(e){const t=e.from===this.username,a=document.createElement("div");a.className="message "+(t?"right":"left"),a.dataset.from=e.from,a.dataset.message=e.message||e.content;let o="";if("audio"===e.type&&e.audioData){let t=e.audioData;t.startsWith("data:")||(t=`data:audio/webm;base64,${t}`),o=`\n                <div class="audio-message">\n                    <span class="audio-icon">ðŸŽµ</span>\n                    <audio controls>\n                        <source src="${t}" type="audio/webm">\n                        Tu navegador no soporta audio.\n                    </audio>\n                </div>\n            `}else o="call"===e.type?`<div class="call-message">ðŸ“ž ${this.escapeHtml(e.message||e.content)}</div>`:`<div class="text">${this.escapeHtml(e.message||e.content)}</div>`;const s=e.timestamp?new Date(e.timestamp).toLocaleTimeString():(new Date).toLocaleTimeString();return a.innerHTML=`\n            <div class="avatar" style="background-color:${this.getAvatarColor(e.from)}">\n                ${e.from[0].toUpperCase()}\n            </div>\n            <div class="text-wrapper">\n                ${t?"":`<div class="user-name">${this.escapeHtml(e.from)}</div>`}\n                ${o}\n                <div class="timestamp">${s}</div>\n            </div>`,a}updateChatInterface(){document.getElementById("chatTarget").textContent=this.targetUser,document.getElementById("groupBadge").style.display=this.isGroupChat?"inline-block":"none";const e=document.getElementById("messageInputWrapper");this.targetUser?e.style.display="flex":e.style.display="none",this.loadUsers(),this.loadGroups()}getAvatarColor(e){return this.colors[e.charCodeAt(0)%this.colors.length]}escapeHtml(e){if(!e)return"";const t=document.createElement("div");return t.textContent=e,t.innerHTML}setupEventListeners(){document.getElementById("messageInput").addEventListener("keypress",e=>{"Enter"===e.key&&this.sendMessage()}),setInterval(()=>{this.loadUsers()},1e4)}}let t;window.onload=()=>{t=new e},window.sendMessage=function(){console.log("sendMessage llamado"),t?t.sendMessage():console.error("chatApp no inicializado")},window.createGroup=function(){console.log("createGroup llamado"),t?t.createGroup():console.error("chatApp no inicializado")},window.sendVoiceNote=function(){console.log("sendVoiceNote llamado, isRecording:",t?.isRecording),t?t.isRecording?t.stopRecording():t.sendVoiceNote():console.error("chatApp no inicializado")},window.startCall=function(){console.log("startCall llamado"),t?t.startCall():console.error("chatApp no inicializado")}})();
//# sourceMappingURL=chat.js.map